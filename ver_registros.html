<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base de Datos del SGI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Estilo inspirado en Google Material Design */
        :root {
            --brand-color: #ef4444; /* red-500 */
            --brand-color-light: #fee2e2; /* red-100 */
            --text-primary: #1f2937; /* Gray-800 */
            --text-secondary: #6b7280; /* Gray-500 */
            --surface-background: #ffffff;
            --page-background: #f9fafb; /* Gray-50 */
        }

        body {
            background-color: var(--page-background);
            color: var(--text-primary);
            font-family: 'Roboto', sans-serif; /* Google Font */
        }

        /* Tipografía de Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        .card {
            background-color: var(--surface-background);
            border-radius: 0.75rem; /* Esquinas más redondeadas */
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            border: 1px solid #e5e7eb; /* Gray-200 */
        }
        
        .tab-btn {
            padding: 1rem 1.5rem;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .tab-btn.active, .tab-btn:hover {
            color: var(--brand-color);
        }
        .tab-btn.active {
            border-bottom-color: var(--brand-color);
        }

        input[type="text"], select {
            border-radius: 0.5rem;
            border-color: #d1d5db; /* Gray-300 */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="text"]:focus, select:focus {
            border-color: var(--brand-color);
            box-shadow: 0 0 0 2px var(--brand-color-light);
            outline: none;
        }

        /* Píldoras de estado */
        .status-pill {
            padding: 0.2rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .status-green { background-color: #dcfce7; color: #166534; }
        .status-red { background-color: #fee2e2; color: #991b1b; }
        .status-yellow { background-color: #fef9c3; color: #854d0e; }
        .status-blue { background-color: #dbeafe; color: #1e40af; }
        .status-purple { background-color: #ede9fe; color: #5b21b6; }
        .status-gray { background-color: #f3f4f6; color: #4b5563; }

        /* Esqueleto de carga */
        .skeleton-row td .skeleton {
            background-color: #e5e7eb;
            border-radius: 0.25rem;
            height: 1.25rem;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="p-6 md:p-8">

    <main class="max-w-7xl mx-auto">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Base de Datos</h1>
        </header>

        <div class="card">
            <div class="border-b border-gray-200">
                <nav class="flex -mb-px px-4" aria-label="Tabs">
                    <button data-tab="docentes" class="tab-btn active">Docentes</button>
                    <button data-tab="alumnos" class="tab-btn">Alumnos</button>
                    <button data-tab="aulas" class="tab-btn">Aulas</button>
                    <button data-tab="historial" class="tab-btn">Historial</button>
                </nav>
            </div>
            
            <div id="tab-content-docentes" class="tab-content p-5">
                <div class="mb-4"><input type="text" id="docentes-search" placeholder="Buscar por nombre, DNI o email..." class="w-full md:w-1/3 p-2 border rounded-md"></div>
                <div class="overflow-x-auto"><table class="w-full text-left text-xs"><thead class="bg-gray-50 text-gray-600"><tr><th class="p-4 font-medium">Nombre</th><th class="p-4 font-medium">DNI</th><th class="p-4 font-medium">Email</th><th class="p-4 font-medium">Teléfono</th><th class="p-4 font-medium text-center">Aulas Activas</th></tr></thead><tbody id="docentes-table-body"></tbody></table></div>
            </div>

            <div id="tab-content-alumnos" class="tab-content p-5 hidden">
                <div class="card border-gray-200 border bg-gray-50 p-4 mb-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                        <input type="text" id="alumnos-search" placeholder="Buscar por nombre, DNI..." class="p-2 border rounded-md lg:col-span-2">
                        <select id="alumnos-curso-filter" class="p-2 border rounded-md"></select>
                        <select id="alumnos-estado-filter" class="p-2 border rounded-md"></select>
                        <button id="clear-alumnos-filters-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md">Limpiar</button>
                    </div>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-left text-xs"><thead class="bg-gray-50 text-gray-600"><tr><th class="p-4 font-medium">Nombre</th><th class="p-4 font-medium">DNI</th><th class="p-4 font-medium">Celular</th><th class="p-4 font-medium">Aula Actual</th><th class="p-4 font-medium">Estado</th><th class="p-4 font-medium">Acciones</th></tr></thead><tbody id="alumnos-table-body"></tbody></table></div>
            </div>

            <div id="tab-content-aulas" class="tab-content p-5 hidden">
                 <div class="card border-gray-200 border bg-gray-50 p-4 mb-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        <input type="text" id="aulas-search" placeholder="Buscar por código, docente..." class="p-2 border rounded-md">
                        <select id="aulas-curso-filter" class="p-2 border rounded-md"></select>
                        <select id="aulas-ciclo-filter" class="p-2 border rounded-md"></select>
                        <select id="aulas-estado-filter" class="p-2 border rounded-md"></select>
                    </div>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-left text-xs"><thead class="bg-gray-50 text-gray-600"><tr><th class="p-4 font-medium">Código</th><th class="p-4 font-medium">Docente</th><th class="p-4 font-medium">Curso</th><th class="p-4 font-medium">Ciclo</th><th class="p-4 font-medium text-center">Alumnos</th><th class="p-4 font-medium text-center">Trld.</th><th class="p-4 font-medium">Frecuencia</th><th class="p-4 font-medium">Horario</th><th class="p-4 font-medium">Inicio</th><th class="p-4 font-medium">Fin</th><th class="p-4 font-medium">Estado</th></tr></thead><tbody id="aulas-table-body"></tbody></table></div>
            </div>
            
            <div id="tab-content-historial" class="tab-content p-5 hidden">
                <div class="mb-4"><input type="text" id="historial-search" placeholder="Buscar por descripción o usuario..." class="w-full md:w-1/3 p-2 border rounded-md"></div>
                <div class="overflow-x-auto"><table class="w-full text-left text-xs"><thead class="bg-gray-50 text-gray-600"><tr><th class="p-4 font-medium">Fecha</th><th class="p-4 font-medium">Acción</th><th class="p-4 font-medium">Descripción</th><th class="p-4 font-medium">Usuario</th></tr></thead><tbody id="historial-table-body"></tbody></table></div>
            </div>

            <div id="pagination-controls" class="p-4 border-t border-gray-200 flex justify-between items-center"></div>
        </div>
    </main>
    
    <!-- Modal de Historial de Alumno -->
    <div id="historial-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h3 id="historial-modal-title" class="text-xl font-bold">Historial del Alumno</h3>
                <button id="close-historial-modal" class="text-gray-400 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="historial-modal-content" class="overflow-y-auto flex-grow pr-2"></div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, Timestamp, query, getDocs, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDC--X4Z95kEd7nd5X4P6B5yW6HPTiRxpQ",
            authDomain: "bdv3-ipch.firebaseapp.com",
            projectId: "bdv3-ipch",
            storageBucket: "bdv3-ipch.firebasestorage.app",
            messagingSenderId: "993842726107",
            appId: "1:993842726107:web:5e9d2b56f29238f2dc38fe"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- Estado de la aplicación ---
        const state = {
            dataCache: { docentes: [], alumnos: [], aulas: [], historial: [], trasladosPendientes: [] },
            precomputed: { alumnosCountByAula: {}, aulasActivasByDocente: {} },
            ui: { currentTab: 'docentes', currentPage: 1, filters: {}, searchTerm: '' },
            isInitialLoad: true
        };
        const PAGE_SIZE = 15;
        const DEBOUNCE_DELAY = 250;
        let renderDebounceTimer;

        const uiElements = {
            tabs: document.querySelectorAll('.tab-btn'),
            tabContents: document.querySelectorAll('.tab-content'),
            pagination: document.getElementById('pagination-controls'),
            docentes: { tbody: document.getElementById('docentes-table-body'), search: document.getElementById('docentes-search') },
            alumnos: { tbody: document.getElementById('alumnos-table-body'), search: document.getElementById('alumnos-search'), estadoFilter: document.getElementById('alumnos-estado-filter'), cursoFilter: document.getElementById('alumnos-curso-filter'), clearFiltersBtn: document.getElementById('clear-alumnos-filters-btn') },
            aulas: { tbody: document.getElementById('aulas-table-body'), search: document.getElementById('aulas-search'), cursoFilter: document.getElementById('aulas-curso-filter'), cicloFilter: document.getElementById('aulas-ciclo-filter'), estadoFilter: document.getElementById('aulas-estado-filter') },
            historial: { tbody: document.getElementById('historial-table-body'), search: document.getElementById('historial-search') },
        };
        
        // --- Lógica Principal ---
        function initializeModule() {
            setupEventListeners();
            showSkeletonLoader(uiElements[state.ui.currentTab].tbody, 5);
            startRealtimeListeners();
        }
        
        function startRealtimeListeners() {
            const collections = ['docentes', 'alumnos', 'aulas', 'historialCambios', 'trasladosPendientes'];
            const collectionsMapping = {'historialCambios': 'historial'};
            
            collections.forEach(colName => {
                onSnapshot(query(collection(db, colName)), snapshot => {
                    const cacheKey = collectionsMapping[colName] || colName;
                    state.dataCache[cacheKey] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    if (state.isInitialLoad && ['alumnos', 'aulas'].includes(cacheKey)) {
                         populateFilters();
                    }
                    
                    debouncedRender();
                });
            });
        }
        
        function debouncedRender() {
            clearTimeout(renderDebounceTimer);
            renderDebounceTimer = setTimeout(() => {
                precomputeData();
                if (state.isInitialLoad) {
                    state.isInitialLoad = false;
                }
                renderCurrentView();
            }, DEBOUNCE_DELAY);
        }

        function precomputeData() {
            state.precomputed.alumnosCountByAula = state.dataCache.alumnos.reduce((acc, alumno) => {
                if (alumno.aulaActual && alumno.estado === 'Activo') {
                    acc[alumno.aulaActual] = (acc[alumno.aulaActual] || 0) + 1;
                }
                return acc;
            }, {});

            state.precomputed.aulasActivasByDocente = state.dataCache.aulas.reduce((acc, aula) => {
                if (getDynamicAulaState(aula) !== 'Cerrada') {
                    if (aula.nombreDocente) acc[aula.nombreDocente] = (acc[aula.nombreDocente] || 0) + 1;
                    if (aula.docenteApoyo) acc[aula.docenteApoyo] = (acc[aula.docenteApoyo] || 0) + 1;
                }
                return acc;
            }, {});
        }

        // --- Renderizado y UI ---
        
        function renderCurrentView() {
            const data = getFilteredAndSortedData();
            updatePaginationControls(data.length);
            
            const start = (state.ui.currentPage - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const paginatedData = data.slice(start, end);
            
            renderTable(paginatedData);
        }
        
        function renderTable(data) {
            const { currentTab } = state.ui;
            const tbody = uiElements[currentTab].tbody;

            if (data.length === 0) {
                 if (state.isInitialLoad) {
                    showSkeletonLoader(tbody, 5);
                    return;
                }
                const colspan = tbody.previousElementSibling.firstElementChild.children.length;
                tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center p-10 text-gray-500">
                    <i class="far fa-folder-open text-4xl mb-3"></i><br>
                    No se encontraron registros.
                </td></tr>`;
                return;
            }

            const renderers = {
                docentes: item => `
                    <td class="p-4 font-medium">${item.nombreCompleto || 'N/A'}</td>
                    <td class="p-4 text-gray-600">${item.documentoIdentidad || 'N/A'}</td>
                    <td class="p-4 text-gray-600">${item.email || 'N/A'}</td>
                    <td class="p-4 text-gray-600">${item.telefono || 'N/A'}</td>
                    <td class="p-4 text-gray-600 text-center font-bold text-lg">${state.precomputed.aulasActivasByDocente[item.nombreCompleto] || 0}</td>
                `,
                alumnos: item => `
                    <td class="p-4 font-medium">${item.nombreCompleto || 'N/A'}</td>
                    <td class="p-4 text-gray-600">${item.documentoIdentidad || 'N/A'}</td>
                    <td class="p-4 text-gray-600">${item.telefono || 'N/A'}</td>
                    <td class="p-4 text-gray-600">${item.aulaActual || 'Sin aula'}</td>
                    <td class="p-4">${renderStatusPill(item.estado)}</td>
                    <td class="p-4"><button data-id="${item.id}" class="view-history-btn text-red-600 hover:text-red-800"><i class="fas fa-eye"></i></button></td>
                `,
                aulas: item => {
                    const dynamicState = getDynamicAulaState(item);
                    const fechaInicio = safeToDate(item.fechaInicio)?.toLocaleDateString('es-ES', { year: '2-digit', month: '2-digit', day: '2-digit' }) || '---';
                    const fechaFin = safeToDate(item.fechaFin)?.toLocaleDateString('es-ES', { year: '2-digit', month: '2-digit', day: '2-digit' }) || '---';
                    return `
                        <td class="p-4 font-medium">${item.codigoAula || 'N/A'}</td>
                        <td class="p-4 text-gray-600">${item.nombreDocente || 'N/A'}${item.docenteApoyo ? `<br><span class="text-xs text-gray-500">Apoyo: ${item.docenteApoyo}</span>` : ''}</td>
                        <td class="p-4 text-gray-600">${getCursoNombre(item.tipoAula)}</td>
                        <td class="p-4 text-gray-600 text-center">${item.ciclo || 'N/A'}</td>
                        <td class="p-4 text-gray-600 text-center font-bold">${state.precomputed.alumnosCountByAula[item.codigoAula] || 0}</td>
                        <td class="p-4 text-gray-600 text-center font-bold">${state.dataCache.trasladosPendientes.filter(t => t.aulaDestino === item.codigoAula && t.estado === 'Pendiente').length}</td>
                        <td class="p-4 text-gray-600">${item.frecuencia || 'N/A'}</td>
                        <td class="p-4 text-gray-600">${item.horario || 'N/A'}</td>
                        <td class="p-4 text-gray-600">${fechaInicio}</td>
                        <td class="p-4 text-gray-600">${fechaFin}</td>
                        <td class="p-4">${renderStatusPill(dynamicState)}</td>
                    `;
                },
                historial: item => `
                    <td class="p-4 text-gray-600">${item.fecha ? safeToDate(item.fecha).toLocaleString('es-ES') : 'N/A'}</td>
                    <td class="p-4 font-medium">${item.action || item.accion || 'N/A'}</td>
                    <td class="p-4 text-gray-600">${item.description || item.descripcion || 'N/A'}</td>
                    <td class="p-4 text-gray-600">${item.usuario || 'N/A'}</td>
                `
            };

            tbody.innerHTML = data.map(item => `<tr class="border-b border-gray-200 hover:bg-gray-50">${renderers[state.ui.currentTab](item)}</tr>`).join('');
        }
        
        // --- Lógica de Filtros y Datos ---
        
        function getFilteredAndSortedData() {
            const { currentTab, searchTerm, filters } = state.ui;
            let data = [...state.dataCache[currentTab]];

            if (currentTab === 'alumnos') {
                if(filters.estado) data = data.filter(item => item.estado === filters.estado);
                if(filters.curso) data = data.filter(item => getCursoNombre(item.cursoInscrito) === filters.curso);
            }
            if (currentTab === 'aulas') {
                if(filters.estado) data = data.filter(item => getDynamicAulaState(item) === filters.estado);
                if(filters.curso) data = data.filter(item => item.tipoAula === filters.curso);
                if(filters.ciclo) data = data.filter(item => item.ciclo == filters.ciclo);
            }
            
            if (searchTerm) {
                const searchKeys = {
                    docentes: ['nombreCompleto', 'documentoIdentidad', 'email'],
                    alumnos: ['nombreCompleto', 'documentoIdentidad', 'aulaActual'],
                    aulas: ['codigoAula', 'nombreDocente', 'docenteApoyo'],
                    historial: ['description', 'descripcion', 'usuario', 'action', 'accion']
                };
                data = data.filter(item => searchKeys[currentTab].some(key => item[key] && String(item[key]).toLowerCase().includes(searchTerm)));
            }
            
            const sortConfig = {
                docentes: (a, b) => a.nombreCompleto.localeCompare(b.nombreCompleto),
                alumnos: (a, b) => a.nombreCompleto.localeCompare(b.nombreCompleto),
                aulas: (a, b) => a.codigoAula.localeCompare(b.codigoAula),
                historial: (a, b) => (safeToDate(b.fecha)?.getTime() || 0) - (safeToDate(a.fecha)?.getTime() || 0),
            };
            data.sort(sortConfig[currentTab]);
            
            return data;
        }
        
        // --- Controladores de Eventos ---
        
        function setupEventListeners() {
            uiElements.tabs.forEach(tab => tab.addEventListener('click', handleTabClick));
            
            Object.keys(uiElements).forEach(key => {
                if (key === 'tabs' || key === 'tabContents' || key === 'pagination') return;
                const elements = uiElements[key];
                if (elements.search) elements.search.addEventListener('input', handleSearch);
                if (elements.estadoFilter) elements.estadoFilter.addEventListener('change', e => handleFilterChange('estado', e.target.value));
                if (elements.cursoFilter) elements.cursoFilter.addEventListener('change', e => handleFilterChange('curso', e.target.value));
                if (elements.cicloFilter) elements.cicloFilter.addEventListener('change', e => handleFilterChange('ciclo', e.target.value));
                if (elements.clearFiltersBtn) elements.clearFiltersBtn.addEventListener('click', clearAlumnoFilters);
            });
            
            uiElements.pagination.addEventListener('click', handlePaginationClick);
            document.body.addEventListener('click', e => {
                if (e.target.closest('.view-history-btn')) {
                    openHistorialModal(e.target.closest('.view-history-btn').dataset.id);
                }
            });
            document.getElementById('close-historial-modal').addEventListener('click', () => document.getElementById('historial-modal').classList.add('hidden'));
        }

        function handleTabClick(e) {
            const newTab = e.target.dataset.tab;
            if (newTab === state.ui.currentTab) return;

            state.ui.currentTab = newTab;
            state.ui.currentPage = 1;
            state.ui.searchTerm = '';
            state.ui.filters = {};
            
            uiElements.tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === newTab));
            uiElements.tabContents.forEach(c => c.classList.toggle('hidden', !c.id.endsWith(newTab)));
            
            document.querySelectorAll('input[type="text"], select').forEach(el => {
                if(el.id.includes('search')) el.value = '';
                else if (el.id.includes('filter')) el.selectedIndex = 0;
            });
            
            renderCurrentView();
        }
        
        function handleSearch(e) {
            state.ui.currentPage = 1;
            state.ui.searchTerm = e.target.value.toLowerCase();
            debouncedRender();
        }

        function handleFilterChange(filterKey, value) {
            state.ui.currentPage = 1;
            state.ui.filters[filterKey] = value;
            renderCurrentView();
        }
        
        function clearAlumnoFilters() {
            state.ui.filters = {};
            state.ui.searchTerm = '';
            uiElements.alumnos.search.value = '';
            uiElements.alumnos.estadoFilter.selectedIndex = 0;
            uiElements.alumnos.cursoFilter.selectedIndex = 0;
            renderCurrentView();
        }
        
        // --- Utilidades y Helpers ---
        function safeToDate(firestoreTimestamp) {
            if (!firestoreTimestamp) return null;
            if (typeof firestoreTimestamp.toDate === 'function') return firestoreTimestamp.toDate();
            if (typeof firestoreTimestamp === 'string') {
                const date = new Date(firestoreTimestamp);
                if (!isNaN(date)) return date;
            }
            if (typeof firestoreTimestamp.seconds === 'number') return new Date(firestoreTimestamp.seconds * 1000);
            return null;
        }

        function populateFilters() {
            const cursoMapping = { 'CH-GRL': 'Chino General', 'CH-N': 'Chino para Niños', 'CH-P': 'Chino Privado', 'CH-C': 'Chino Corporativo', 'CI-C': 'Importaciones Corto', 'CI-L': 'Importaciones Largo', 'CE': 'Español' };
            const cursos = [...new Set(state.dataCache.aulas.map(a => a.tipoAula))].sort();
            
            uiElements.aulas.cursoFilter.innerHTML = '<option value="">Todos los Cursos</option>' + cursos.map(c => `<option value="${c}">${cursoMapping[c] || c}</option>`).join('');
            uiElements.aulas.estadoFilter.innerHTML = '<option value="">Todos los Estados</option><option>Programada</option><option>En Curso</option><option>En Cobranza</option><option>Cerrada</option>';
            uiElements.aulas.cursoFilter.addEventListener('change', e => {
                const ciclosPorTipo = { 'CH-GRL': 12, 'CH-N': 6, 'CH-P': 12, 'CH-C': 12, 'CI-C': 1, 'CI-L': 1, 'CE': 12 };
                const maxCiclos = ciclosPorTipo[e.target.value] || 12;
                let options = '<option value="">Todos los Ciclos</option>';
                for (let i = 1; i <= maxCiclos; i++) {
                    options += `<option value="${i}">Ciclo ${i}</option>`;
                }
                uiElements.aulas.cicloFilter.innerHTML = options;
            });

            const alumnoCursos = [...new Set(state.dataCache.alumnos.map(a => a.cursoInscrito).map(c => getCursoNombre(c)))].filter(c => c).sort();
            uiElements.alumnos.cursoFilter.innerHTML = '<option value="">Todos los Cursos</option>' + alumnoCursos.map(c => `<option value="${c}">${c}</option>`).join('');
            
            const alumnoEstados = [...new Set(state.dataCache.alumnos.map(a => a.estado))].filter(e => e).sort();
            uiElements.alumnos.estadoFilter.innerHTML = '<option value="">Todos los Estados</option>' + alumnoEstados.map(e => `<option value="${e}">${e}</option>`).join('');
        }

        function showSkeletonLoader(tbody, rows) {
            const colspan = tbody.previousElementSibling.firstElementChild.children.length;
            let skeletonHTML = '';
            for (let i = 0; i < rows; i++) {
                skeletonHTML += `<tr class="skeleton-row"><td colspan="${colspan}" class="p-4"><div class="skeleton"></div></td></tr>`;
            }
            tbody.innerHTML = skeletonHTML;
        }
        
        function renderStatusPill(status) {
            const s = status || 'N/A';
            const statusMap = {
                'Activo': 'green', 'En Curso': 'green',
                'Retirado': 'red', 'Cerrada': 'red',
                'Pausado': 'yellow', 'En Cobranza': 'yellow', 'Programada': 'yellow',
                'Egresado': 'purple', 'Registrado': 'blue',
            };
            return `<span class="status-pill status-${statusMap[s] || 'gray'}">${s}</span>`;
        }

        function getCursoNombre(code) {
             if (!code) return null;
             const cursoMapping = { 'CH-GRL': 'Chino General', 'CH-N': 'Chino para Niños', 'CH-P': 'Chino Privado', 'CH-C': 'Chino Corporativo', 'CI-C': 'Importaciones Corto', 'CI-L': 'Importaciones Largo', 'CE': 'Español' };
             return cursoMapping[code] || code;
        }

        function getDynamicAulaState(aula) {
            if (aula.estado === 'Cerrada') return 'Cerrada';
            const today = new Date(); today.setHours(0,0,0,0);
            const inicio = safeToDate(aula.fechaInicio);
            const fin = safeToDate(aula.fechaFin);
            if(!inicio || !fin) return aula.estado;
            if(inicio > today) return 'Programada';
            if(fin < today) return 'En Cobranza';
            return 'En Curso';
        }

        function updatePaginationControls(totalItems) {
            const totalPages = Math.ceil(totalItems / PAGE_SIZE);
            if (totalPages <= 1) {
                uiElements.pagination.innerHTML = '';
                return;
            }
            const { currentPage } = state.ui;
            uiElements.pagination.innerHTML = `
                <span class="text-sm text-gray-600">Mostrando ${Math.min((currentPage-1)*PAGE_SIZE + 1, totalItems)} - ${Math.min(currentPage*PAGE_SIZE, totalItems)} de ${totalItems} registros</span>
                <div>
                    <button data-action="prev" class="pagination-btn bg-white hover:bg-gray-100 border text-gray-800 font-semibold py-2 px-4 rounded-l disabled:opacity-50 disabled:cursor-not-allowed" ${currentPage === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>
                    <button data-action="next" class="pagination-btn bg-white hover:bg-gray-100 border text-gray-800 font-semibold py-2 px-4 rounded-r disabled:opacity-50 disabled:cursor-not-allowed" ${currentPage === totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>
                </div>
            `;
        }
        
        function handlePaginationClick(e) {
            const action = e.target.closest('.pagination-btn')?.dataset.action;
            if(!action) return;
            if(action === 'prev' && state.ui.currentPage > 1) state.ui.currentPage--;
            if(action === 'next') {
                const totalPages = Math.ceil(getFilteredAndSortedData().length / PAGE_SIZE);
                if (state.ui.currentPage < totalPages) state.ui.currentPage++;
            }
            renderCurrentView();
        }

        async function openHistorialModal(alumnoId) {
            const modal = document.getElementById('historial-modal');
            const modalContent = document.getElementById('historial-modal-content');
            document.getElementById('historial-modal-title').textContent = 'Cargando historial...';
            modalContent.innerHTML = `<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-3xl text-red-500"></i></div>`;
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            try {
                const [historialSnap, carterasSnap] = await Promise.all([
                    getDocs(query(collection(db, "historialAlumnos"), where("alumnoId", "==", alumnoId), orderBy("fecha", "desc"))),
                    getDocs(query(collection(db, "historialCarteras"), orderBy("fechaArchivado", "desc")))
                ]);

                const alumno = state.dataCache.alumnos.find(a => a.id === alumnoId);
                document.getElementById('historial-modal-title').textContent = `Historial de: ${alumno?.nombreCompleto || 'Alumno'}`;
                
                let transaccionesHTML = '<div><h4 class="font-bold text-lg mb-2">Historial de Transacciones</h4>';
                if (historialSnap.empty) {
                    transaccionesHTML += '<p class="text-gray-500">No hay transacciones registradas.</p>';
                } else {
                    transaccionesHTML += '<div class="space-y-4">';
                    historialSnap.docs.forEach(doc => {
                        const data = doc.data();
                        const fecha = safeToDate(data.fecha)?.toLocaleString('es-ES') || 'Fecha inválida';
                        transaccionesHTML += `<div class="p-4 border rounded-md bg-gray-50"><p class="font-semibold text-gray-800">${data.tipoAccion} <span class="text-sm font-normal text-gray-500">- ${fecha}</span></p><p class="text-sm text-gray-600 mt-1">${data.descripcion}</p><p class="text-sm text-gray-800 mt-2"><strong>Motivo:</strong> <span class="italic">${data.motivo || 'N/A'}</span></p><p class="text-xs text-gray-400 text-right mt-1">Realizado por: ${data.usuario}</p></div>`;
                    });
                    transaccionesHTML += '</div>';
                }
                transaccionesHTML += '</div>';
                
                const allPossibleNotes = [];
                carterasSnap.forEach(doc => {
                    const cartera = doc.data();
                    const alumnoEnCartera = cartera.alumnos.find(a => a.id === alumnoId);
                    if (alumnoEnCartera && typeof alumnoEnCartera.notaFinal !== 'undefined') {
                        allPossibleNotes.push({ aula: cartera.datosAula.codigoAula, ciclo: cartera.datosAula.ciclo, nota: alumnoEnCartera.notaFinal, fecha: cartera.fechaArchivado });
                    }
                });
                historialSnap.docs.forEach(doc => {
                    const historial = doc.data();
                    if (historial.detalles && typeof historial.detalles.notaFinal !== 'undefined') {
                        allPossibleNotes.push({ aula: historial.detalles.aula || historial.detalles.aulaOrigen || 'N/A', ciclo: historial.detalles.ciclo || historial.detalles.cicloOrigen || 'N/A', nota: historial.detalles.notaFinal, fecha: historial.fecha });
                    }
                });

                const finalNotasMap = new Map();
                allPossibleNotes.forEach(note => {
                    const key = `${note.aula}-${note.ciclo}`;
                    const existing = finalNotasMap.get(key);
                    if (!existing || safeToDate(note.fecha) > safeToDate(existing.fecha)) {
                        finalNotasMap.set(key, note);
                    }
                });
                
                const notas = Array.from(finalNotasMap.values()).filter(n => n.nota !== null).sort((a,b) => safeToDate(b.fecha) - safeToDate(a.fecha));

                let academicoHTML = '<div class="mt-6"><h4 class="font-bold text-lg mb-2">Historial Académico</h4>';
                if (notas.length === 0) {
                    academicoHTML += '<p class="text-gray-500">No hay notas finales registradas.</p>';
                } else {
                    academicoHTML += '<table class="w-full text-left text-sm"><thead><tr class="border-b"><th class="py-2">Aula</th><th class="py-2">Ciclo</th><th class="py-2 text-center">Nota Final</th></tr></thead><tbody>';
                    notas.forEach(n => {
                        const notaClass = n.nota === null ? '' : (n.nota >= 11 ? 'text-green-600' : 'text-red-600');
                        academicoHTML += `<tr class="border-b"><td class="py-2">${n.aula}</td><td class="py-2">${n.ciclo}</td><td class="py-2 text-center font-bold ${notaClass}">${n.nota ?? 'N/A'}</td></tr>`;
                    });
                    academicoHTML += '</tbody></table>';
                }
                academicoHTML += '</div>';

                modalContent.innerHTML = transaccionesHTML + academicoHTML;

            } catch(error) {
                console.error("Error al cargar historial:", error);
                modalContent.innerHTML = `<p class="text-red-500 p-8 text-center">Ocurrió un error al cargar el historial.</p>`;
            }
        }
        
        // --- Inicialización ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                initializeModule();
            } else {
                document.body.innerHTML = `<div class="text-center p-10 text-red-500">Error de autenticación. Por favor, inicie sesión de nuevo.</div>`;
            }
        });

    </script>
</body>
</html>