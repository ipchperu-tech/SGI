<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo de Estadísticas Avanzadas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos personalizados para mejorar la UI */
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: box-shadow 0.3s ease-in-out;
        }
        .card:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn-primary {
            background-color: #CF0000; /* Indigo 600 */
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #AB0202; /* Indigo 700 */
        }
        .loader {
            border: 4px solid #f3f4f6; /* Gray 100 */
            border-top: 4px solid #CF0000; /* Indigo 600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-6 md:p-10">

    <div class="max-w-7xl mx-auto">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">Estadísticas y Reportes</h2>

        <!-- Pantalla de Selección de Reporte -->
        <div id="selector-screen" class="max-w-2xl mx-auto card p-8 text-center">
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Generar un Reporte</h3>
            <p class="text-gray-600 mb-6">Selecciona los parámetros para visualizar las estadísticas.</p>
            <div class="space-y-4">
                <select id="report-type-filter" class="w-full p-3 border rounded-md bg-gray-50 font-semibold" title="Seleccionar tipo de reporte">
                    <option value="generales">Estadísticas Generales (Tiempo Real)</option>
                    <option value="docentes">Rendimiento por Docente (Histórico)</option>
                    <option value="ciclos">Aprobados vs. Reprobados (Histórico)</option>
                </select>
                <select id="curso-filter" class="w-full p-3 border rounded-md bg-gray-50" title="Filtrar por Curso"></select>
                <div id="date-filters-container" class="grid grid-cols-2 gap-4">
                    <select id="year-filter" class="w-full p-3 border rounded-md bg-gray-50"></select>
                    <select id="month-filter" class="w-full p-3 border rounded-md bg-gray-50"></select>
                </div>
                <button id="view-report-btn" class="w-full btn-primary font-semibold py-3 px-6 rounded-md text-lg">Ver Reporte</button>
            </div>
        </div>
        
        <div id="loader" class="text-center py-10 hidden">
            <div class="loader inline-block"></div>
            <p class="text-gray-500 mt-2">Generando reporte...</p>
        </div>

        <div id="stats-content" class="hidden space-y-8">
            <button id="back-to-selector-btn" class="mb-2 text-sm text-gray-600 hover:text-red-700 font-semibold">
                <i class="fas fa-arrow-left mr-2"></i>Volver a seleccionar
            </button>
            <!-- Contenedor para Reportes -->
            <div id="reports-container">
                <!-- Reporte: Estadísticas Generales -->
                <div id="report-generales" class="report-view space-y-8">
                    <div>
                        <h3 class="text-xl font-bold text-gray-700 mb-4">Métricas Clave (Tiempo Real)</h3>
                        <div id="kpi-container-generales" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6">
                            <!-- KPIs se generan dinámicamente aquí -->
                        </div>
                    </div>
                </div>
                
                <!-- Reporte: Rendimiento por Docente -->
                <div id="report-docentes" class="report-view hidden space-y-8">
                    <div class="card p-6">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                            <h3 class="font-bold">Rendimiento por Docente (Alumnos Totales)</h3>
                            <select id="docente-filter" class="p-2 border rounded-md bg-gray-50 text-sm max-w-xs"></select>
                        </div>
                        <div id="docente-chart-container" class="chart-container relative" style="min-height: 400px;">
                            <canvas id="rendimiento-docente-chart"></canvas>
                            <div id="docente-no-data-msg" class="hidden absolute inset-0 flex items-center justify-center text-gray-500 bg-gray-50/50 rounded-lg p-4"></div>
                        </div>
                    </div>
                </div>

                <!-- Reporte: Aprobados vs. Reprobados por Ciclo -->
                <div id="report-ciclos" class="report-view hidden space-y-8">
                     <div class="card p-6">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                            <h3 class="font-bold text-center w-full sm:w-auto">Aprobados vs. Reprobados (Histórico por Ciclo)</h3>
                            <select id="rendimiento-ciclo-filter" class="p-2 border rounded-md bg-gray-50 text-sm" title="Filtro de Ciclo"></select>
                        </div>
                        <div class="chart-container relative" style="height: 450px;"><canvas id="rendimiento-ciclo-chart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN DE ANÁLISIS CON IA DE GEMINI -->
            <div id="ai-analysis-section" class="card p-6">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h3 class="font-bold text-lg flex items-center gap-2">
                        <i class="fas fa-brain text-indigo-500"></i>
                        Análisis con Inteligencia Artificial
                    </h3>
                    <button id="generate-analysis-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md text-sm">
                        <i class="fas fa-magic mr-2"></i>Generar Análisis del Reporte Actual
                    </button>
                </div>
                <div id="analysis-container">
                    <p class="text-gray-500 text-center py-4">Haz clic en "Generar Análisis" para obtener insights sobre el reporte actual.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración de Firebase (debes reemplazarla con tus credenciales) ---
        const firebaseConfig = {
          apiKey: "AIzaSyDC--X4Z95kEd7nd5X4P6B5yW6HPTiRxpQ",
          authDomain: "bdv3-ipch.firebaseapp.com",
          projectId: "bdv3-ipch",
          storageBucket: "bdv3-ipch.firebasestorage.app",
          messagingSenderId: "993842726107",
          appId: "1:993842726107:web:5e9d2b56f29238f2dc38fe"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        Chart.register(ChartDataLabels);

        // --- Selectores de UI ---
        const loader = document.getElementById('loader');
        const selectorScreen = document.getElementById('selector-screen');
        const statsContent = document.getElementById('stats-content');
        const viewReportBtn = document.getElementById('view-report-btn');
        const backToSelectorBtn = document.getElementById('back-to-selector-btn');
        
        const reportTypeFilter = document.getElementById('report-type-filter');
        const cursoFilter = document.getElementById('curso-filter');
        const monthFilter = document.getElementById('month-filter');
        const yearFilter = document.getElementById('year-filter');
        const docenteFilter = document.getElementById('docente-filter');
        const rendimientoCicloFilter = document.getElementById('rendimiento-ciclo-filter');
        const dateFiltersContainer = document.getElementById('date-filters-container');
        const generateAnalysisBtn = document.getElementById('generate-analysis-btn');
        const analysisContainer = document.getElementById('analysis-container');
        
        let rendimientoDocenteChart, rendimientoCicloChart;
        let dataCache = { alumnos: [], historialCarteras: [], docentes: [], aulas: [], historialAlumnos: [] };
        let isInitialLoad = true;
        let availableMonths = [];

        const codeToCursoName = { 'CH-GRL': 'Chino General', 'CH-N': 'Chino para Niños', 'CH-P': 'Chino Privado', 'CH-C': 'Chino Corporativo', 'CI-C': 'Importaciones Corto', 'CI-L': 'Importaciones Largo', 'CE': 'Español' };
        const ciclosPorCurso = { 'Chino General': 12, 'Chino para Niños': 6, 'Chino Privado': 12, 'Chino Corporativo': 12, 'Importaciones Corto': 1, 'Importaciones Largo': 1, 'Español': 12 };

        // --- Lógica de Filtros ---
        function populateFilters() {
            const cursos = new Set(Object.values(codeToCursoName));
            cursoFilter.innerHTML = '<option value="" disabled selected>Seleccione un curso...</option>';
            [...cursos].sort().forEach(c => cursoFilter.innerHTML += `<option value="${c}">${c}</option>`);
            
            const docentes = new Set(dataCache.docentes.map(d => d.nombreCompleto).filter(Boolean));
            docenteFilter.innerHTML = '<option value="">Todos los Docentes</option>';
            [...docentes].sort().forEach(d => docenteFilter.innerHTML += `<option value="${d}">${d}</option>`);

            updateCicloFilter();
        }

        function populateDateFilters() {
            const uniqueMonths = [...new Set(dataCache.historialCarteras.map(c => `${c.anoArchivado}-${String(c.mesArchivado + 1).padStart(2, '0')}`))].sort().reverse();
            availableMonths = uniqueMonths;
            const years = [...new Set(availableMonths.map(m => m.split('-')[0]))];

            yearFilter.innerHTML = '';
            years.forEach(y => yearFilter.innerHTML += `<option value="${y}">${y}</option>`);

            if (years.length > 0) {
                updateMonthFilterForYear(years[0]);
            }
        }

        function updateMonthFilterForYear(selectedYear) {
            const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            monthFilter.innerHTML = '<option value="all">Todo el Año</option>';
            availableMonths.forEach(monthStr => {
                const [year, month] = monthStr.split('-');
                if(year === selectedYear) {
                    monthFilter.innerHTML += `<option value="${parseInt(month) - 1}">${meses[parseInt(month) - 1]}</option>`;
                }
            });
        }
        
        function updateCicloFilter() {
            const selectedCurso = cursoFilter.value;
            rendimientoCicloFilter.innerHTML = '<option value="">Todos los Ciclos</option>';
            if (selectedCurso && ciclosPorCurso[selectedCurso]) {
                const maxCiclos = ciclosPorCurso[selectedCurso];
                for (let i = 1; i <= maxCiclos; i++) {
                    rendimientoCicloFilter.innerHTML += `<option value="${i}">Ciclo ${i}</option>`;
                }
            }
        }
        
        function handleReportTypeChange() {
            const reportType = reportTypeFilter.value;
            const isGeneralReport = reportType === 'generales';
            dateFiltersContainer.style.display = isGeneralReport ? 'none' : 'grid';
            cursoFilter.style.display = 'block';
            document.getElementById('ai-analysis-section').style.display = isGeneralReport ? 'none' : 'block';

            if (!isGeneralReport) {
                if (!cursoFilter.querySelector('option[value=""]')) {
                    cursoFilter.insertAdjacentHTML('afterbegin', '<option value="">Todos los Cursos</option>');
                }
            } else {
                const allCoursesOption = cursoFilter.querySelector('option[value=""]');
                if (allCoursesOption) allCoursesOption.remove();
            }
        }

        // --- Lógica de Renderizado de Reportes ---
        function renderVisibleReport() {
            selectorScreen.classList.add('hidden');
            loader.classList.remove('hidden');
            statsContent.classList.add('hidden');

            setTimeout(() => {
                document.querySelectorAll('.report-view').forEach(view => view.classList.add('hidden'));
                const reportType = reportTypeFilter.value;
                document.getElementById(`report-${reportType}`).classList.remove('hidden');

                switch (reportType) {
                    case 'generales': renderReporteGenerales(); break;
                    case 'docentes': renderReporteDocentes(); break;
                    case 'ciclos': renderReporteCiclos(); break;
                }
                
                loader.classList.add('hidden');
                statsContent.classList.remove('hidden');
                analysisContainer.innerHTML = `<p class="text-gray-500 text-center py-4">Haz clic en "Generar Análisis" para obtener insights sobre el reporte actual.</p>`;
            }, 500);
        }

        function renderKPI(containerId, icon, label, value, color) {
            const container = document.getElementById(containerId);
            container.innerHTML += `
                <div class="card p-4 flex items-center gap-4">
                    <i class="fas ${icon} text-3xl ${color}"></i>
                    <div>
                        <p class="text-sm text-gray-500">${label}</p>
                        <p class="text-3xl font-bold text-gray-800">${value}</p>
                    </div>
                </div>`;
        }

        function renderReporteGenerales() {
            const selectedCurso = cursoFilter.value;
            const kpiContainer = document.getElementById('kpi-container-generales');
            kpiContainer.innerHTML = '';
            
            const alumnosFiltrados = dataCache.alumnos.filter(a => (codeToCursoName[a.cursoInscrito] || a.cursoInscrito) === selectedCurso);
            const aulasFiltradas = dataCache.aulas.filter(a => (codeToCursoName[a.tipoAula] || a.tipoAula) === selectedCurso);

            renderKPI('kpi-container-generales', 'fa-user-check', 'Alumnos Activos', alumnosFiltrados.filter(a => a.estado === 'Activo').length, 'text-green-500');
            renderKPI('kpi-container-generales', 'fa-user-slash', 'Alumnos Retirados', alumnosFiltrados.filter(a => a.estado === 'Retirado').length, 'text-red-500');
            renderKPI('kpi-container-generales', 'fa-user-clock', 'Alumnos Pausados', alumnosFiltrados.filter(a => a.estado === 'Pausado').length, 'text-yellow-500');
            renderKPI('kpi-container-generales', 'fa-user-graduate', 'Alumnos Egresados', alumnosFiltrados.filter(a => a.estado === 'Egresado').length, 'text-purple-500');
            
            const aulasActivas = aulasFiltradas.filter(a => ['En Curso', 'Programada'].includes(a.estado)).length;
            renderKPI('kpi-container-generales', 'fa-chalkboard-teacher', 'Aulas Activas/Prog.', aulasActivas, 'text-blue-500');
        }

        function renderReporteDocentes() {
            // *** FIX: Destroy existing chart instance before creating a new one ***
            if (rendimientoDocenteChart) {
                rendimientoDocenteChart.destroy();
            }

            const selectedCurso = cursoFilter.value;
            const selectedMonth = monthFilter.value;
            const selectedYear = parseInt(yearFilter.value);
            const selectedDocente = docenteFilter.value;

            const carterasFiltradas = dataCache.historialCarteras.filter(c => {
                const yearMatch = c.anoArchivado === selectedYear;
                const monthMatch = (selectedMonth === 'all') || (c.mesArchivado == selectedMonth);
                const cursoDeCartera = codeToCursoName[c.datosAula.tipoAula] || c.datosAula.tipoAula;
                const cursoMatch = !selectedCurso || cursoDeCartera === selectedCurso;
                
                return yearMatch && monthMatch && cursoMatch;
            });
            
            const rendimiento = {};
            carterasFiltradas.forEach(cartera => {
                const docente = cartera.datosAula.nombreDocente;
                if (docente) {
                    if (!rendimiento[docente]) rendimiento[docente] = { aprobados: 0, reprobados: 0, desercion: 0, total: 0 };
                    
                    cartera.alumnos.forEach(al => {
                        rendimiento[docente].total++;
                        
                        if (typeof al.notaFinal === 'number' && al.notaFinal !== null) {
                            if (al.notaFinal >= 11) rendimiento[docente].aprobados++;
                            else rendimiento[docente].reprobados++;
                        }
                        
                        if (al.estadoCobranza === 'Retirado' || al.estadoCobranza === 'Pausado') {
                            rendimiento[docente].desercion++;
                        }
                    });
                }
            });
            
            const noDataMsg = document.getElementById('docente-no-data-msg');
            const chartCanvas = document.getElementById('rendimiento-docente-chart');
            const chartContainer = document.getElementById('docente-chart-container');
            noDataMsg.classList.add('hidden');
            chartCanvas.classList.remove('hidden');

            const finalRendimiento = selectedDocente ? { [selectedDocente]: rendimiento[selectedDocente] } : rendimiento;
            const docentesLabels = Object.keys(finalRendimiento).filter(d => finalRendimiento[d] && finalRendimiento[d].total > 0);

            if (docentesLabels.length === 0) {
                const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                const monthName = selectedMonth === 'all' ? `todo el año` : `el mes de ${meses[selectedMonth]}`;
                noDataMsg.textContent = `No se encontraron datos de aulas archivadas para los filtros seleccionados (${selectedDocente || 'Todos los docentes'} en ${monthName} de ${selectedYear}).`;
                noDataMsg.classList.remove('hidden');
                chartCanvas.classList.add('hidden');
                chartContainer.style.height = '100px'; // Altura fija para el mensaje
                return;
            }

            // *** MEJORA: ALTURA DINÁMICA DEL GRÁFICO ***
            const dynamicHeight = (docentesLabels.length * 70) + 150; // 70px por docente + 150px base
            chartContainer.style.height = `${Math.max(400, dynamicHeight)}px`;

            const docenteCtx = chartCanvas.getContext('2d');
            rendimientoDocenteChart = new Chart(docenteCtx, {
                type: 'bar',
                data: {
                    labels: docentesLabels,
                    datasets: [
                        { label: 'Aprobados', data: docentesLabels.map(d => finalRendimiento[d].aprobados), backgroundColor: '#22C55E' },
                        { label: 'Reprobados', data: docentesLabels.map(d => finalRendimiento[d].reprobados), backgroundColor: '#EF4444' },
                        { label: 'Deserción (Paus/Ret)', data: docentesLabels.map(d => finalRendimiento[d].desercion), backgroundColor: '#F59E0B' }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false }, stacked: true },
                        y: { 
                            stacked: true,
                            ticks: {
                                callback: function(value, index) {
                                    const label = this.getLabelForValue(value);
                                    if (label && finalRendimiento[label]) {
                                        const total = finalRendimiento[label].total;
                                        return [label, `Total Alumnos: ${total}`];
                                    }
                                    return label;
                                },
                                font: { size: 12 }
                            },
                            barPercentage: 0.9,
                            categoryPercentage: 0.8
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: {
                            formatter: (value) => value > 0 ? value : '',
                            color: 'white',
                            font: { weight: 'bold' }
                        }
                    }
                }
            });
        }

        function renderReporteCiclos() {
            // *** FIX: Destroy existing chart instance before creating a new one ***
            if (rendimientoCicloChart) {
                rendimientoCicloChart.destroy();
            }

            const selectedCurso = cursoFilter.value;
            const selectedMonth = monthFilter.value;
            const selectedYear = parseInt(yearFilter.value);
            const selectedCiclo = rendimientoCicloFilter.value;

            const carterasFiltradas = dataCache.historialCarteras.filter(c => {
                const yearMatch = c.anoArchivado === selectedYear;
                const monthMatch = (selectedMonth === 'all') || (c.mesArchivado == selectedMonth);
                const cursoDeCartera = codeToCursoName[c.datosAula.tipoAula] || c.datosAula.tipoAula;
                const cursoMatch = !selectedCurso || cursoDeCartera === selectedCurso;
                return yearMatch && monthMatch && cursoMatch;
            });

            const rendimiento = {};
            carterasFiltradas.forEach(cartera => {
                const cicloNum = cartera.datosAula.ciclo;
                if (!selectedCiclo || cicloNum == selectedCiclo) {
                    const cicloLabel = `Ciclo ${cicloNum}`;
                    if (!rendimiento[cicloLabel]) rendimiento[cicloLabel] = { aprobados: 0, reprobados: 0, total: 0 };
                    
                    cartera.alumnos.forEach(al => {
                        if (typeof al.notaFinal === 'number' && al.notaFinal !== null) {
                                rendimiento[cicloLabel].total++;
                            if (al.notaFinal >= 11) {
                                rendimiento[cicloLabel].aprobados++;
                            } else {
                                rendimiento[cicloLabel].reprobados++;
                            }
                        }
                    });
                }
            });
            
            const ciclosLabels = Object.keys(rendimiento).sort((a,b) => parseInt(a.split(' ')[1]) - parseInt(b.split(' ')[1]));
            
            const cicloCtx = document.getElementById('rendimiento-ciclo-chart').getContext('2d');
            rendimientoCicloChart = new Chart(cicloCtx, {
                type: 'bar',
                data: {
                    labels: ciclosLabels,
                    datasets: [
                        { label: 'Aprobados', data: ciclosLabels.map(c => rendimiento[c].aprobados), backgroundColor: '#22C55E', stack: 'Stack 0' },
                        { label: 'Reprobados', data: ciclosLabels.map(c => rendimiento[c].reprobados), backgroundColor: '#EF4444', stack: 'Stack 0' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        x: { 
                            stacked: true,
                            barPercentage: 0.5,
                            categoryPercentage: 0.6,
                            ticks: {
                                callback: function(value, index) {
                                    const label = this.getLabelForValue(value);
                                    if(label && rendimiento[label]) {
                                        return [label, `(Total: ${rendimiento[label].total})`];
                                    }
                                    return label;
                                }
                            }
                        }, 
                        y: { 
                            stacked: true 
                        } 
                    },
                    plugins: { 
                        legend: { position: 'bottom' },
                        datalabels: {
                            formatter: (value) => value > 0 ? value : '',
                            color: 'white',
                            font: { weight: 'bold' }
                        }
                    }
                }
            });
        }
        
        async function generateAIAnalysis() {
            analysisContainer.innerHTML = `<div class="text-center py-10"><div class="loader inline-block"></div><p class="text-gray-500 mt-2">Gemini está analizando los datos...</p></div>`;
            generateAnalysisBtn.disabled = true;

            try {
                // IMPORTANTE: Recuerda manejar tu API Key de forma segura.
                const apiKey = "AIzaSyBcVtyl2MKEHdk1LO4M5w_pEuR0hT0h_Iw";

                const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                const reportType = reportTypeFilter.value;
                const selectedCurso = cursoFilter.value || "Todos los Cursos";
                let dataSummary = "";
                let context = "";
                const selectedMonth = monthFilter.value !== "" && monthFilter.value !== 'all' ? meses[monthFilter.value] : "Todo el año";
                const selectedYear = yearFilter.value;
                dataSummary = `Periodo: ${selectedMonth} de ${selectedYear}\nCurso: ${selectedCurso}\n`;

                if (reportType === 'docentes') {
                    context = "Analiza el rendimiento de los docentes. La 'Deserción' se refiere a alumnos retirados o pausados, sin importar su nota. Un alumno puede ser contado como 'Reprobado' y también como 'Desertor'. Identifica a los docentes con mejor y peor rendimiento (aprobados vs reprobados) y aquellos con mayores tasas de deserción. Sugiere posibles causas o acciones.";
                    const data = { labels: rendimientoDocenteChart.data.labels, datasets: rendimientoDocenteChart.data.datasets };
                    dataSummary += "Reporte de Rendimiento por Docente (Aprobados, Reprobados, Deserción):\n";
                    data.labels.forEach((label, index) => {
                        dataSummary += `- ${label}: ${data.datasets.map(d => `${d.label}: ${d.data[index]}`).join(', ')}\n`;
                    });
                } else if (reportType === 'ciclos') {
                    context = "Analiza el rendimiento académico por ciclo. Identifica los ciclos con mayor y menor tasa de aprobación y sugiere posibles puntos de acción.";
                    const data = { labels: rendimientoCicloChart.data.labels, datasets: rendimientoCicloChart.data.datasets };
                    dataSummary += "Reporte de Aprobados vs Reprobados por Ciclo:\n";
                    data.labels.forEach((label, index) => {
                        dataSummary += `- ${label}: ${data.datasets.map(d => `${d.label}: ${d.data[index]}`).join(', ')}\n`;
                    });
                } else {
                     analysisContainer.innerHTML = `<p class="text-gray-500 text-center py-4">El análisis de IA solo está disponible para reportes históricos.</p>`;
                     generateAnalysisBtn.disabled = false;
                     return;
                }
                
                const systemPrompt = `Eres un analista de datos experto para el Instituto Peruano Chino (IPCH). Tu tarea es interpretar métricas de rendimiento académico y estudiantil. ${context} Proporciona un resumen conciso y luego destaca de 3 a 5 insights clave o puntos de atención en formato de lista. Sé profesional, directo y enfócate en información accionable para la dirección académica y administrativa.`;
                const userQuery = `Analiza los siguientes datos del SGI y genera el reporte solicitado:\n\n${dataSummary}`;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) throw new Error(`La llamada a la API de Gemini falló con estado: ${response.status}`);
                
                const result = await response.json();
                const analysisText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (analysisText) {
                    const formattedText = analysisText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\* (.*?)(\n|$)/g, '<li>$1</li>').replace(/<\/li><li>/g, '</li><li>').replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>').replace(/\n/g, '<br>');
                    analysisContainer.innerHTML = `<div class="text-gray-700 p-4 bg-gray-50 rounded-md">${formattedText}</div>`;
                } else {
                    throw new Error("La respuesta de la IA no contiene texto.");
                }
            } catch (error) {
                console.error("Error generating AI analysis:", error);
                analysisContainer.innerHTML = `<div class="p-4 bg-red-50 border-l-4 border-red-500 text-red-700"><p class="font-bold">Error al generar el análisis</p><p class="text-sm mt-1">${error.message || 'No se pudo contactar al servicio de IA. Intenta de nuevo más tarde.'}</p></div>`;
            } finally {
                generateAnalysisBtn.disabled = false;
            }
        }

        // --- Inicialización y Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            
            loader.classList.remove('hidden');
            selectorScreen.classList.add('hidden');
            
            const collectionsToLoad = ['alumnos', 'historialCarteras', 'docentes', 'aulas', 'historialAlumnos'];
            let loadedCount = 0;
            const onDataLoaded = () => {
                if (++loadedCount === collectionsToLoad.length) {
                    isInitialLoad = false;
                    populateFilters();
                    populateDateFilters();
                    loader.classList.add('hidden');
                    selectorScreen.classList.remove('hidden');
                    handleReportTypeChange();
                }
            };

            collectionsToLoad.forEach(name => {
                onSnapshot(query(collection(db, name)), snapshot => {
                    dataCache[name] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (isInitialLoad) {
                        onDataLoaded();
                    } else if (document.getElementById('stats-content').offsetParent !== null) {
                         const currentReport = reportTypeFilter.value;
                         if(currentReport === 'docentes') renderReporteDocentes();
                         if(currentReport === 'ciclos') renderReporteCiclos();
                    }
                });
            });
            
            viewReportBtn.addEventListener('click', () => {
                if (reportTypeFilter.value === 'generales' && !cursoFilter.value) {
                    // Simula una notificación (idealmente tendrías un sistema de notificaciones)
                    alert('Por favor, seleccione un curso para ver las estadísticas generales.');
                    return;
                }
                renderVisibleReport();
            });

            backToSelectorBtn.addEventListener('click', () => {
                statsContent.classList.add('hidden');
                selectorScreen.classList.remove('hidden');
            });
            
            reportTypeFilter.addEventListener('change', handleReportTypeChange);
            cursoFilter.addEventListener('change', updateCicloFilter);
            docenteFilter.addEventListener('change', () => {
                if(reportTypeFilter.value === 'docentes') renderReporteDocentes();
            });
            rendimientoCicloFilter.addEventListener('change', () => {
                 if(reportTypeFilter.value === 'ciclos') renderReporteCiclos();
            });
            yearFilter.addEventListener('change', () => updateMonthFilterForYear(yearFilter.value));
            monthFilter.addEventListener('change', () => {
                const currentReport = reportTypeFilter.value;
                if(statsContent.offsetParent !== null) { // Solo renderiza si los reportes están visibles
                    if (currentReport === 'docentes') renderReporteDocentes();
                    if (currentReport === 'ciclos') renderReporteCiclos();
                }
            });

            generateAnalysisBtn.addEventListener('click', generateAIAnalysis);
        });
    </script>
</body>
</html>

