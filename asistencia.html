<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Asistencia - IPCH</title>
    <link rel="icon" href="https://ipch.net.pe/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" href="https://ipch.net.pe/wp-content/uploads/2025/07/IPCH-VERTICAL-V1-COLOR.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .btn-primary { background-color: #c80000; color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #a20000; }
        .btn-primary:disabled { background-color: #fca5a5; cursor: not-allowed; }
        .btn-secondary { background-color: #e2e8f0; color: #475569; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .loader { border: 4px solid #fee2e2; border-top: 4px solid #c80000; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #login-screen, #app-container { display: none; }

        /* Estilos para la tabla responsive de administrador en móviles */
        @media (max-width: 768px) {
            #admin-view table.responsive-table { border: 0; }
            #admin-view table.responsive-table thead { display: none; }
            #admin-view table.responsive-table tr { display: block; margin-bottom: 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); background-color: white; }
            #admin-view table.responsive-table td { display: block; text-align: right; border-bottom: 1px solid #f1f5f9; position: relative; padding-left: 50%; padding-top: 0.75rem; padding-bottom: 0.75rem; }
            #admin-view table.responsive-table td:last-child { border-bottom: 0; }
            #admin-view table.responsive-table td::before { content: attr(data-label); position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); width: calc(50% - 2rem); text-align: left; font-weight: 600; color: #475569; }
            #admin-view table.responsive-table td.no-results-cell { text-align: center; padding-left: 1rem; }
            #admin-view table.responsive-table td.no-results-cell::before { content: ""; }
        }

        /* Estilos para el efecto de flash de la cámara */
        #camera-flash.flash-effect {
            animation: flash 0.5s ease-out;
        }
        @keyframes flash {
            0% { opacity: 0; }
            50% { opacity: 0.8; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="preloader" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <img src="https://ipch.net.pe/wp-content/uploads/2025/07/IPCH-VERTICAL-V1-COLOR.png" alt="Logotipo del Instituto" class="w-24 h-24 mx-auto" onerror="this.onerror=null; this.src='https://placehold.co/96x96/fee2e2/c80000?text=IPCH';">
            <p class="mt-4 text-gray-600">Cargando Sistema de Asistencia...</p>
        </div>
    </div>

    <!-- Pantalla de Login -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-xl shadow-lg">
            <div class="text-center">
                <img src="https://ipch.net.pe/wp-content/uploads/2025/07/IPCH-VERTICAL-V1-COLOR.png" alt="Logotipo del Instituto" class="w-20 h-20 mx-auto mb-4" onerror="this.onerror=null; this.src='https://placehold.co/80x80/fee2e2/c80000?text=IPCH';">
                <h2 class="text-2xl font-bold text-gray-900">Registro de Asistencia</h2>
                <p class="mt-2 text-sm text-gray-600">Inicia sesión para continuar.</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="text-sm font-bold text-gray-600 block">Correo Electrónico</label>
                    <input type="email" id="email" class="w-full p-3 mt-1 bg-gray-50 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500" required>
                </div>
                <div>
                    <label for="password" class="text-sm font-bold text-gray-600 block">Contraseña</label>
                    <div class="relative">
                        <input type="password" id="password" class="w-full p-3 mt-1 bg-gray-50 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500 pr-10" required>
                        <button type="button" id="togglePasswordAttendance" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <button type="submit" id="loginBtn" class="w-full btn-primary font-bold py-3 px-4 rounded-md">Iniciar Sesión</button>
                </div>
                <p id="loginError" class="text-sm text-center text-red-600"></p>
            </form>
             <p class="text-xs text-gray-500 text-center mt-4">
                <i class="fas fa-shield-alt mr-1"></i>
                Este sistema emplea un monitoreo de actividad basado en la dirección IP para auditar la productividad durante el horario laboral registrado.
            </p>
        </div>
    </div>

    <!-- Contenedor Principal de la App -->
    <div id="app-container" class="min-h-screen">
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center gap-4">
                        <img src="https://ipch.net.pe/wp-content/uploads/2025/07/IPCH-VERTICAL-V1-COLOR.png" alt="Logotipo" class="h-10 w-10" onerror="this.onerror=null; this.style.display='none';">
                        <h1 class="text-xl font-bold text-gray-800">Control de Asistencia</h1>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-4">
                        <div id="user-info" class="text-right overflow-hidden"></div>
                        <button id="logout-btn" class="text-gray-500 hover:text-red-600 flex-shrink-0" title="Cerrar Sesión"><i class="fas fa-sign-out-alt fa-lg"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <main class="p-4 sm:p-6 lg:p-8">
            <div id="view-switcher" class="max-w-7xl mx-auto mb-6 text-center"></div>

            <!-- Vista de Colaborador -->
            <div id="employee-view" class="max-w-xl mx-auto space-y-6">
                <div class="card p-8 text-center">
                    <h3 id="greeting" class="text-2xl font-bold text-gray-800"></h3>
                    <p id="current-date" class="text-sm text-gray-500"></p>
                    <p id="daily-quote" class="text-md text-gray-700 mt-4 italic"></p>
                    <button id="mark-attendance-btn" class="mt-6 btn-primary font-bold py-4 px-8 rounded-lg text-lg transition-transform transform hover:scale-105">Marcar Asistencia</button>
                    <div id="last-event-status" class="mt-4 text-sm text-gray-600"></div>
                </div>
                <div class="card p-6">
                    <h3 class="font-bold text-lg mb-4">Registros de Hoy</h3>
                    <div id="today-records-loader" class="text-center"><div class="loader inline-block"></div></div>
                    <ul id="today-records-list" class="space-y-2"></ul>
                </div>
            </div>

            <!-- Vista de Administrador -->
            <div id="admin-view" class="max-w-7xl mx-auto hidden">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4">Panel de Administración de Asistencias</h2>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4 items-end">
                        <div class="md:col-span-2">
                            <label for="user-filter" class="block text-sm font-medium text-gray-700">Filtrar por Colaborador</label>
                            <select id="user-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                <option value="">Todos los Colaboradores</option>
                            </select>
                        </div>
                        <div>
                            <label for="month-filter" class="block text-sm font-medium text-gray-700">Mes</label>
                            <select id="month-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                        </div>
                        <div>
                            <label for="year-filter" class="block text-sm font-medium text-gray-700">Año</label>
                            <select id="year-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                        </div>
                        <div>
                            <button id="export-btn" class="w-full btn-secondary font-bold py-2 px-4 rounded-md flex items-center justify-center gap-2">
                                <i class="fas fa-file-excel"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left responsive-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-4">Colaborador</th>
                                    <th class="p-4">Fecha</th>
                                    <th class="p-4">Registros</th>
                                    <th class="p-4">Horas Trabajadas</th>
                                    <th class="p-4" id="admin-actions-header">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="admin-table-body">
                                <tr><td colspan="5" class="text-center p-10"><div class="loader inline-block"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal para Editar Asistencia -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[102] p-4">
        <div class="card p-6 rounded-lg w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 id="edit-modal-title" class="text-xl font-bold">Editar Registro de Asistencia</h3>
                <button id="close-edit-modal" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
            </div>
            <form id="edit-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Colaborador</label>
                    <p id="edit-employee-name" class="mt-1 p-2 bg-gray-100 rounded-md"></p>
                </div>
                <div id="edit-events-container" class="space-y-3 max-h-64 overflow-y-auto">
                    <!-- Los campos de edición se generan aquí -->
                </div>
                <div class="flex justify-end pt-4">
                    <button type="submit" id="save-edit-btn" class="btn-primary font-bold py-2 px-4 rounded-md">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Cámara Falsa -->
    <div id="camera-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-[103] p-4">
        <div class="text-center text-white">
            <div class="w-64 h-64 sm:w-80 sm:h-80 bg-gray-900 rounded-lg flex items-center justify-center border-4 border-gray-700 relative overflow-hidden">
                <i class="fas fa-user-circle text-9xl text-gray-600"></i>
                <div id="camera-flash" class="absolute inset-0 bg-white opacity-0"></div>
                <div class="absolute bottom-4 text-sm font-semibold">
                    <p>Verificación Facial</p>
                    <p>Sonría, por favor...</p>
                </div>
            </div>
            <p class="mt-4 text-lg">Procesando asistencia...</p>
        </div>
    </div>


    <script type="module">
import { db, auth } from "./js/firebase-config.js";
import { onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { collection, doc, getDoc, addDoc, query, where, onSnapshot, Timestamp, orderBy, limit, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let currentUser = null;
        let adminUnsubscribe = null;
        let adminDataCache = [];
        let inactivityTimer;

        const preloader = document.getElementById('preloader');
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const currentDateEl = document.getElementById('current-date');
        const markAttendanceBtn = document.getElementById('mark-attendance-btn');
        const lastEventStatusEl = document.getElementById('last-event-status');
        const todayRecordsList = document.getElementById('today-records-list');
        const todayRecordsLoader = document.getElementById('today-records-loader');
        const viewSwitcher = document.getElementById('view-switcher');
        const employeeView = document.getElementById('employee-view');
        const adminView = document.getElementById('admin-view');
        const adminTableBody = document.getElementById('admin-table-body');
        const userFilter = document.getElementById('user-filter');
        const monthFilter = document.getElementById('month-filter');
        const yearFilter = document.getElementById('year-filter');
        const exportBtn = document.getElementById('export-btn');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const cameraModal = document.getElementById('camera-modal');
        const greetingEl = document.getElementById('greeting');
        const dailyQuoteEl = document.getElementById('daily-quote');
        
        // Lógica para mostrar/ocultar contraseña
        const togglePasswordBtn = document.getElementById('togglePasswordAttendance');
        const passwordInput = document.getElementById('password');

        if (togglePasswordBtn && passwordInput) {
            togglePasswordBtn.addEventListener('click', () => {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                const icon = togglePasswordBtn.querySelector('i');
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });
        }
        
        const timeZone = 'America/Lima';
        const dateFormatter = new Intl.DateTimeFormat('es-PE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', timeZone });
        const timeFormatter = new Intl.DateTimeFormat('es-PE', { timeStyle: 'medium', hour12: true, timeZone });
        const timeInputFormatter = (date) => date.toLocaleTimeString('en-CA', { hour12: false, hour: '2-digit', minute: '2-digit', timeZone });

        const getTodayInPeru = () => new Date(new Date().toLocaleString('en-US', { timeZone }));
        const getTodayString = () => getTodayInPeru().toLocaleDateString('en-CA');

        const motivationalQuotes = [
            "El éxito es la suma de pequeños esfuerzos repetidos día tras día.",
            "Cree en ti mismo y todo lo que eres. Reconoce que hay algo dentro de ti que es más grande que cualquier obstáculo.",
            "La única forma de hacer un gran trabajo es amar lo que haces.",
            "El futuro pertenece a quienes creen en la belleza de sus sueños.",
            "No te preocupes por los fracasos, preocúpate por las oportunidades que pierdes cuando ni siquiera lo intentas.",
            "La disciplina es el puente entre las metas y los logros.",
            "El optimismo es la fe que conduce al logro. Nada puede hacerse sin esperanza y confianza.",
            "El secreto para salir adelante es empezar.",
            "Tu actitud, no tu aptitud, determinará tu altitud.",
            "No esperes. El momento nunca será el 'perfecto'.",
            "Un objetivo sin un plan es solo un deseo.",
            "La perseverancia no es una carrera larga; son muchas carreras cortas una tras otra.",
            "El talento gana partidos, pero el trabajo en equipo y la inteligencia ganan campeonatos.",
            "La mejor manera de predecir el futuro es crearlo.",
            "Si puedes soñarlo, puedes hacerlo."
        ];

        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip || 'No disponible';
            } catch (error) {
                console.error("Error fetching IP address:", error);
                return 'Error de red';
            }
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                if (currentUser) {
                    sessionStorage.removeItem('asistenciaSessionActive');
                    showLoginScreen();
                }
            }, 5 * 60 * 1000);
        }

        function setupInactivityListeners() {
            window.addEventListener('mousemove', resetInactivityTimer);
            window.addEventListener('keydown', resetInactivityTimer);
            window.addEventListener('click', resetInactivityTimer);
            window.addEventListener('scroll', resetInactivityTimer);
            resetInactivityTimer();
        }

        function removeInactivityListeners() {
            window.removeEventListener('mousemove', resetInactivityTimer);
            window.removeEventListener('keydown', resetInactivityTimer);
            window.removeEventListener('click', resetInactivityTimer);
            window.removeEventListener('scroll', resetInactivityTimer);
            clearTimeout(inactivityTimer);
        }

        onAuthStateChanged(auth, async (user) => {
            const isSessionActive = sessionStorage.getItem('asistenciaSessionActive') === 'true';
            if (user && isSessionActive) {
                const userDocRef = doc(db, "usuarios", user.email);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    currentUser = { uid: user.uid, email: user.email, ...userDocSnap.data() };
                    initializeAppUI();
                } else {
                    await signOut(auth);
                    sessionStorage.removeItem('asistenciaSessionActive');
                    showLoginScreen();
                }
            } else {
                currentUser = null;
                sessionStorage.removeItem('asistenciaSessionActive');
                showLoginScreen();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginBtn.disabled = true;
            loginBtn.textContent = "Ingresando...";
            loginError.textContent = "";
            try {
                const credential = await signInWithEmailAndPassword(auth, loginForm.email.value, loginForm.password.value);
                if (credential.user) {
                    sessionStorage.setItem('asistenciaSessionActive', 'true');
                    const userDocRef = doc(db, "usuarios", credential.user.email);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        currentUser = { uid: credential.user.uid, email: credential.user.email, ...userDocSnap.data() };
                        initializeAppUI();
                    } else {
                        throw new Error("User data not found in Firestore.");
                    }
                }
            } catch (error) {
                loginError.textContent = "Correo o contraseña incorrectos.";
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = "Iniciar Sesión";
            }
        });

        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('asistenciaSessionActive');
            showLoginScreen();
        });

        function isUserAdmin() {
            if (!currentUser || !currentUser.rol) return false;
            const adminRoles = ['director marketing', 'administración y presidencia', 'auditor'];
            return adminRoles.includes(currentUser.rol.trim().toLowerCase());
        }

        function isUserAuditor() {
            if (!currentUser || !currentUser.rol) return false;
            return currentUser.rol.trim().toLowerCase() === 'auditor';
        }

        function initializeAppUI() {
            preloader.style.display = 'none';
            loginScreen.style.display = 'none';
            appContainer.style.display = 'block';
            userInfo.innerHTML = `
                <p class="font-semibold text-sm text-gray-800 truncate">${currentUser.nombreCompleto}</p>
                <p class="text-xs text-gray-500">${currentUser.rol}</p>`;
            
            const today = getTodayInPeru();
            const firstName = currentUser.nombreCompleto.split(' ')[0];
            greetingEl.textContent = `¡Hola de nuevo, ${firstName}!`;
            currentDateEl.textContent = dateFormatter.format(today);

            const startOfYear = new Date(today.getFullYear(), 0, 0);
            const diff = today - startOfYear;
            const oneDay = 1000 * 60 * 60 * 24;
            const dayOfYear = Math.floor(diff / oneDay);
            const quote = motivationalQuotes[dayOfYear % motivationalQuotes.length];
            dailyQuoteEl.textContent = `"${quote}"`;

            if (isUserAdmin()) {
                setupViewSwitcher();
                showView('employee');
            } else {
                viewSwitcher.innerHTML = '';
                showView('employee');
            }
            
            document.getElementById('admin-actions-header').style.display = isUserAuditor() ? '' : 'none';
            listenToUserEvents();
            populateDateFilters();
            setupInactivityListeners();
        }

        function showLoginScreen() {
            preloader.style.display = 'none';
            appContainer.style.display = 'none';
            loginScreen.style.display = 'flex';
            loginForm.reset(); 
            removeInactivityListeners();
        }
        
        function handleAttendanceClick() {
            markAttendanceBtn.disabled = true;
            markAttendanceBtn.innerHTML = '<div class="loader inline-block"></div>';

            cameraModal.classList.remove('hidden');
            cameraModal.classList.add('flex');

            setTimeout(() => {
                const flash = document.getElementById('camera-flash');
                flash.classList.add('flash-effect');

                setTimeout(async () => {
                    cameraModal.classList.add('hidden');
                    cameraModal.classList.remove('flex');
                    flash.classList.remove('flash-effect');
                    
                    await markAttendance(); 
                }, 500); 
            }, 1500);
        }

        async function markAttendance() {
            try {
                const todayStr = getTodayString();
                const q = query(
                    collection(db, "asistencia_eventos"),
                    where("userId", "==", currentUser.email),
                    where("fecha", "==", todayStr)
                );
                const snapshot = await getDocs(q);
                const events = snapshot.docs.map(doc => doc.data());
                const entradas = events.filter(e => e.tipo === 'entrada');
                const salidas = events.filter(e => e.tipo === 'salida');
                
                let newEventType = (entradas.length > salidas.length) ? 'salida' : 'entrada';

                if (newEventType === 'entrada' && entradas.length >= 3) {
                    console.error("No se pueden registrar más de 3 entradas.");
                    return; 
                }

                const ip = await getIPAddress();
                
                await addDoc(collection(db, "asistencia_eventos"), {
                    userId: currentUser.email,
                    nombreCompleto: currentUser.nombreCompleto,
                    fecha: getTodayString(),
                    timestamp: Timestamp.now(),
                    tipo: newEventType,
                    ip: ip
                });
            } catch (error) {
                console.error("Error marking attendance:", error);
                lastEventStatusEl.textContent = 'Ocurrió un error al marcar la asistencia.';
                markAttendanceBtn.disabled = false;
            }
        }

        function listenToUserEvents() {
            const todayStr = getTodayString();
            const q = query(
                collection(db, "asistencia_eventos"),
                where("userId", "==", currentUser.email),
                where("fecha", "==", todayStr),
                orderBy("timestamp", "asc")
            );
            onSnapshot(q, (snapshot) => {
                todayRecordsLoader.style.display = 'none';
                
                const events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const entradas = events.filter(e => e.tipo === 'entrada');
                const salidas = events.filter(e => e.tipo === 'salida');

                if (entradas.length >= 3 && entradas.length === salidas.length) {
                    markAttendanceBtn.disabled = true;
                    markAttendanceBtn.textContent = 'Jornada Completa';
                    lastEventStatusEl.textContent = 'Has completado todos tus registros de hoy.';
                } else {
                    markAttendanceBtn.disabled = false;
                    if (entradas.length > salidas.length) {
                        markAttendanceBtn.textContent = `Marcar Salida #${salidas.length + 1}`;
                    } else {
                        markAttendanceBtn.textContent = `Marcar Entrada #${entradas.length + 1}`;
                    }
                }

                if (events.length === 0) {
                    lastEventStatusEl.textContent = 'Aún no has marcado tu asistencia hoy.';
                    todayRecordsList.innerHTML = '<li class="text-center text-gray-500 text-sm">No hay registros para hoy.</li>';
                } else {
                    const lastEvent = events[events.length - 1];
                    lastEventStatusEl.textContent = `Última marca: ${lastEvent.tipo.charAt(0).toUpperCase() + lastEvent.tipo.slice(1)} a las ${timeFormatter.format(lastEvent.timestamp.toDate())}`;
                    
                    let recordsHTML = '';
                    const maxPairs = Math.max(entradas.length, salidas.length);

                    for (let i = 0; i < maxPairs; i++) {
                        recordsHTML += '<li class="p-2 border-b space-y-1 text-sm">';
                        if (entradas[i]) {
                            recordsHTML += `<div class="flex justify-between items-center"><span class="font-semibold text-green-600">ENTRADA ${i + 1}</span><span>${timeFormatter.format(entradas[i].timestamp.toDate())}</span></div>`;
                        }
                        if (salidas[i]) {
                            recordsHTML += `<div class="flex justify-between items-center"><span class="font-semibold text-red-600">SALIDA ${i + 1}</span><span>${timeFormatter.format(salidas[i].timestamp.toDate())}</span></div>`;
                        }
                        recordsHTML += '</li>';
                    }
                    todayRecordsList.innerHTML = recordsHTML;
                }
            });
        }

        function setupViewSwitcher() {
            viewSwitcher.innerHTML = `<div class="inline-flex rounded-md shadow-sm"><button id="show-employee-view" class="btn-primary font-semibold py-2 px-4 rounded-l-md">Mi Asistencia</button><button id="show-admin-view" class="btn-secondary font-semibold py-2 px-4 rounded-r-md">Ver Equipo</button></div>`;
            document.getElementById('show-employee-view').addEventListener('click', () => showView('employee'));
            document.getElementById('show-admin-view').addEventListener('click', () => showView('admin'));
        }

        function showView(viewName) {
            const employeeBtn = document.getElementById('show-employee-view');
            const adminBtn = document.getElementById('show-admin-view');
            if (viewName === 'admin') {
                employeeView.classList.add('hidden');
                adminView.classList.remove('hidden');
                if(employeeBtn) {
                    employeeBtn.classList.replace('btn-primary', 'btn-secondary');
                    adminBtn.classList.replace('btn-secondary', 'btn-primary');
                }
                loadAdminData();
            } else {
                adminView.classList.add('hidden');
                employeeView.classList.remove('hidden');
                if(adminBtn) {
                    adminBtn.classList.replace('btn-primary', 'btn-secondary');
                    employeeBtn.classList.replace('btn-secondary', 'btn-primary');
                }
                if (adminUnsubscribe) { adminUnsubscribe(); adminUnsubscribe = null; }
            }
        }
        
        async function loadAdminData() {
            if (adminUnsubscribe) adminUnsubscribe();
            
            const usersSnap = await getDocs(query(collection(db, "usuarios"), orderBy("nombreCompleto")));
            populateUserFilter(usersSnap.docs.map(d => d.data().nombreCompleto));
            
            const q = query(collection(db, "asistencia_eventos"), orderBy("timestamp", "desc"));
            adminUnsubscribe = onSnapshot(q, (snapshot) => {
                adminDataCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminTable();
            });
        }
        
        function populateUserFilter(users) {
            const currentSelection = userFilter.value;
            userFilter.innerHTML = '<option value="">Todos los Colaboradores</option>';
            users.forEach(user => userFilter.innerHTML += `<option value="${user}">${user}</option>`);
            userFilter.value = currentSelection;
        }

        function populateDateFilters() {
            const now = getTodayInPeru();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            monthFilter.innerHTML = '';
            meses.forEach((mes, index) => monthFilter.innerHTML += `<option value="${index}">${mes}</option>`);
            yearFilter.innerHTML = '';
            for (let i = currentYear; i >= currentYear - 3; i--) yearFilter.innerHTML += `<option value="${i}">${i}</option>`;
            monthFilter.value = currentMonth;
            yearFilter.value = currentYear;
        }
        
        function getFilteredDataForAdmin() {
            let filteredEvents = adminDataCache;
            const selectedUser = userFilter.value;
            if (selectedUser) {
                filteredEvents = filteredEvents.filter(item => item.nombreCompleto === selectedUser);
            }
            const selectedMonth = parseInt(monthFilter.value);
            const selectedYear = parseInt(yearFilter.value);
            filteredEvents = filteredEvents.filter(item => {
                const itemDate = item.timestamp.toDate();
                return itemDate.getMonth() === selectedMonth && itemDate.getFullYear() === selectedYear;
            });
            
            return filteredEvents;
        }
        
        function renderAdminTable() {
            const auditor = isUserAuditor();
            document.getElementById('admin-actions-header').style.display = auditor ? '' : 'none';
            const colspan = auditor ? 5 : 4;
            const headers = Array.from(adminTableBody.parentElement.querySelectorAll('th')).map(th => th.textContent.trim());

            let filteredEvents = getFilteredDataForAdmin();

            const groupedByUserAndDate = filteredEvents.reduce((acc, event) => {
                const key = `${event.userId}_${event.fecha}`;
                if (!acc[key]) {
                    acc[key] = {
                        nombreCompleto: event.nombreCompleto,
                        userId: event.userId,
                        fecha: event.fecha,
                        events: []
                    };
                }
                acc[key].events.push(event);
                return acc;
            }, {});

            const dailySummaries = Object.values(groupedByUserAndDate).map(day => {
                const dayEvents = day.events.sort((a,b) => a.timestamp.seconds - b.timestamp.seconds);
                const entradas = dayEvents.filter(e => e.tipo === 'entrada');
                const salidas = dayEvents.filter(e => e.tipo === 'salida');
                
                let totalMillis = 0;
                for (let i = 0; i < Math.min(entradas.length, salidas.length); i++) {
                    totalMillis += salidas[i].timestamp.toDate() - entradas[i].timestamp.toDate();
                }

                const diffHrs = totalMillis / 3600000;
                const hours = Math.floor(diffHrs);
                const minutes = Math.floor((diffHrs - hours) * 60);

                return {
                    ...day,
                    entradas,
                    salidas,
                    horasTrabajadas: `${hours}h ${minutes}m`
                };
            }).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            if(dailySummaries.length === 0) {
                adminTableBody.innerHTML = `<tr><td colspan="${colspan}" class="no-results-cell text-center p-6 text-gray-500">No hay registros con los filtros seleccionados.</td></tr>`;
                return;
            }
            
            adminTableBody.innerHTML = dailySummaries.map(day => {
                const formatTime = (event) => {
                    const time = timeFormatter.format(event.timestamp.toDate());
                    const ipIcon = `<i class="fas fa-network-wired text-gray-400 ml-2" title="IP: ${event.ip || 'N/A'}"></i>`;
                    return `${time} ${ipIcon}`;
                };

                let registrosHTML = '';
                const maxPairs = Math.max(day.entradas.length, day.salidas.length);

                if (maxPairs === 0) {
                    registrosHTML = 'N/A';
                } else {
                    for (let i = 0; i < maxPairs; i++) {
                        if (day.entradas[i]) {
                            registrosHTML += `<div class="text-sm"><span class="font-semibold text-green-600">Entrada ${i + 1}:</span> ${formatTime(day.entradas[i])}</div>`;
                        }
                        if (day.salidas[i]) {
                            registrosHTML += `<div class="text-sm mt-1"><span class="font-semibold text-red-600">Salida ${i + 1}:</span> ${formatTime(day.salidas[i])}</div>`;
                        }
                        if (i < maxPairs - 1) {
                            registrosHTML += '<hr class="my-2 border-gray-100">';
                        }
                    }
                }
                
                const editButtonCell = auditor ? `<td class="p-4 align-top" data-label="${headers[4]}"><button data-id="${day.userId}_${day.fecha}" class="edit-btn text-blue-600 hover:underline text-sm">Editar</button></td>` : '';
                
                return `
                    <tr class="border-b">
                        <td class="p-4 align-top font-medium" data-label="${headers[0]}">${day.nombreCompleto}</td>
                        <td class="p-4 align-top" data-label="${headers[1]}">${dateFormatter.format(new Date(day.fecha + "T12:00:00Z"))}</td>
                        <td class="p-4" data-label="${headers[2]}">${registrosHTML}</td>
                        <td class="p-4 align-top font-semibold" data-label="${headers[3]}">${day.horasTrabajadas}</td>
                        ${editButtonCell}
                    </tr>`;
            }).join('');
        }

        [userFilter, monthFilter, yearFilter].forEach(el => el.addEventListener('change', renderAdminTable));
        
        adminTableBody.addEventListener('click', (e) => {
             if (e.target.classList.contains('edit-btn')) {
                 const [userId, fecha] = e.target.dataset.id.split('_');
                 const dayEvents = adminDataCache.filter(event => event.userId === userId && event.fecha === fecha);
                 if (dayEvents.length > 0) {
                     openEditModal(dayEvents);
                 }
            }
        });
        
        function openEditModal(dayEvents) {
            const container = document.getElementById('edit-events-container');
            container.innerHTML = '';
            document.getElementById('edit-employee-name').textContent = dayEvents[0].nombreCompleto;
            
            const events = dayEvents.sort((a,b) => a.timestamp.seconds - b.timestamp.seconds);
            const entradas = events.filter(e => e.tipo === 'entrada');
            const salidas = events.filter(e => e.tipo === 'salida');

            const maxPairs = Math.max(entradas.length, salidas.length);

            for (let i = 0; i < maxPairs; i++) {
                const pairContainer = document.createElement('div');
                pairContainer.className = 'p-2 border rounded-md space-y-2';

                if (entradas[i]) {
                    const event = entradas[i];
                    const div = document.createElement('div');
                    const labelText = `Entrada #${i + 1}`;
                    div.innerHTML = `
                        <label class="block text-sm font-medium text-gray-700">${labelText}</label>
                        <input type="time" data-event-id="${event.id}" value="${timeInputFormatter(event.timestamp.toDate())}" class="mt-1 w-full p-2 border rounded-md">
                    `;
                    pairContainer.appendChild(div);
                }

                if (salidas[i]) {
                    const event = salidas[i];
                    const div = document.createElement('div');
                    const labelText = `Salida #${i + 1}`;
                    div.innerHTML = `
                        <label class="block text-sm font-medium text-gray-700">${labelText}</label>
                        <input type="time" data-event-id="${event.id}" value="${timeInputFormatter(event.timestamp.toDate())}" class="mt-1 w-full p-2 border rounded-md">
                    `;
                    pairContainer.appendChild(div);
                }
                container.appendChild(pairContainer);
            }

            editModal.classList.remove('hidden');
            editModal.classList.add('flex');
        }
        
        document.getElementById('close-edit-modal').addEventListener('click', () => editModal.classList.add('hidden'));

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveBtn = document.getElementById('save-edit-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';

            const inputs = editForm.querySelectorAll('#edit-events-container input[type="time"]');
            const batch = writeBatch(db);

            try {
                for (const input of inputs) {
                    const eventId = input.dataset.eventId;
                    const newTime = input.value;
                    if (!eventId || !newTime) continue;

                    const originalEvent = adminDataCache.find(ev => ev.id === eventId);
                    if (!originalEvent) continue;

                    const recordDateStr = originalEvent.fecha;
                    const newTimestamp = Timestamp.fromDate(new Date(`${recordDateStr}T${newTime}:00-05:00`));

                    const eventRef = doc(db, "asistencia_eventos", eventId);
                    batch.update(eventRef, { timestamp: newTimestamp });
                }

                await batch.commit();
                editModal.classList.add('hidden');

            } catch (error) {
                console.error("Error updating records:", error);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Guardar Cambios';
            }
        });

        markAttendanceBtn.addEventListener('click', handleAttendanceClick);

        exportBtn.addEventListener('click', () => {
            const filteredData = getFilteredDataForAdmin();
            
            if (filteredData.length === 0) {
                console.log("No hay datos para exportar con los filtros seleccionados.");
                return;
            }

            const groupedByUserAndDate = filteredData.reduce((acc, event) => {
                const key = `${event.userId}_${event.fecha}`;
                if (!acc[key]) {
                    acc[key] = { nombreCompleto: event.nombreCompleto, fecha: event.fecha, events: [] };
                }
                acc[key].events.push(event);
                return acc;
            }, {});

            const dailySummaries = Object.values(groupedByUserAndDate).map(day => {
                 const events = day.events.sort((a,b) => a.timestamp.seconds - b.timestamp.seconds);
                const entradas = events.filter(e => e.tipo === 'entrada');
                const salidas = events.filter(e => e.tipo === 'salida');
                
                let totalMillis = 0;
                for (let i = 0; i < Math.min(entradas.length, salidas.length); i++) {
                     totalMillis += salidas[i].timestamp.toDate() - entradas[i].timestamp.toDate();
                }

                const diffHrs = totalMillis / 3600000;
                const hours = Math.floor(diffHrs);
                const minutes = Math.floor((diffHrs - hours) * 60);

                return {
                    nombreCompleto: day.nombreCompleto,
                    fecha: dateFormatter.format(new Date(day.fecha + "T12:00:00Z")),
                    entradas: entradas.map(e => timeFormatter.format(e.timestamp.toDate())).join(", "),
                    salidas: salidas.map(s => timeFormatter.format(s.timestamp.toDate())).join(", "),
                    horasTrabajadas: `${hours}h ${minutes}m`
                };
            });

            const csvRows = [
                ["Colaborador", "Fecha", "Entradas", "Salidas", "Horas Trabajadas"]
            ];
            
            dailySummaries.forEach(summary => {
                csvRows.push([
                    `"${summary.nombreCompleto}"`,
                    `"${summary.fecha}"`,
                    `"${summary.entradas}"`,
                    `"${summary.salidas}"`,
                    `"${summary.horasTrabajadas}"`
                ]);
            });

            const csvContent = "data:text/csv;charset=utf-8," + csvRows.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const monthName = monthFilter.options[monthFilter.selectedIndex].text;
            const year = yearFilter.value;
            link.setAttribute("download", `Reporte_Asistencia_${monthName}_${year}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

    </script>
</body>
</html>

