<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MÃ³dulo de Registro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-6 md:p-10">

    <h2 class="text-3xl font-bold text-gray-800 mb-6">Registrar Nueva Data</h2>
    
    <!-- Pantalla de SelecciÃ³n de Registro -->
    <div id="registro-selector-screen" class="max-w-xl mx-auto card p-8 text-center">
        <h3 id="registro-greeting" class="text-2xl font-bold text-gray-800 mb-2"></h3>
        <p class="text-gray-600 mb-6">Â¿QuÃ© tipo de data deseas registrar hoy?</p>
        <div class="flex flex-col sm:flex-row items-center gap-4">
            <select id="registro-select" class="w-full p-3 border rounded-md">
                <option value="docente">Registrar Docente</option>
                <option value="colaborador">Registrar Colaborador</option>
                <option value="alumno">Registrar Alumno</option>
                <option value="aula">Registrar Aula</option>
            </select>
            <button id="realizar-registro-btn" class="btn-primary font-semibold py-3 px-6 rounded-md w-full sm:w-auto whitespace-nowrap">Realizar Registro</button>
        </div>
    </div>

    <div id="forms-container">
        <!-- Formulario Docentes -->
        <div id="form-container-docente" class="form-container hidden">
            <div class="card p-6 max-w-lg mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Registrar Nuevo Docente</h3>
                    <button type="button" class="back-to-selector-btn text-sm text-gray-500 hover:text-red-600">&larr; Volver</button>
                </div>
                <form id="form-docente" class="space-y-4">
                    <input type="text" name="nombreCompleto" placeholder="Nombre Completo" class="w-full p-2 border rounded" required>
                    <div class="grid grid-cols-3 gap-4">
                        <select name="tipoDocumento" class="w-full p-2 border rounded col-span-1">
                            <option value="DNI">DNI</option>
                            <option value="RUC">RUC</option>
                            <option value="Pasaporte">Pasaporte</option>
                            <option value="C.E.">C.E.</option>
                            <option value="CÃ©dula">CÃ©dula</option>
                        </select>
                        <input type="text" name="documentoIdentidad" placeholder="Nro. Documento" class="w-full p-2 border rounded col-span-2" required>
                    </div>
                    <div class="flex">
                        <select name="prefijo" class="p-2 border rounded-l-md bg-gray-50 border-r-0">
                            <option value="+51">ðŸ‡µðŸ‡ª +51</option>
                            <option value="+58">ðŸ‡»ðŸ‡ª +58</option>
                            <option value="+57">ðŸ‡¨ðŸ‡´ +57</option>
                            <option value="+52">ðŸ‡²ðŸ‡½ +52</option>
                            <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                            <option value="+34">ðŸ‡ªðŸ‡¸ +34</option>
                            <option value="+54">ðŸ‡¦ðŸ‡· +54</option>
                        </select>
                        <input type="tel" name="telefono" placeholder="TelÃ©fono" class="w-full p-2 border rounded-r-md" required>
                    </div>
                    <input type="email" name="email" placeholder="Email" class="w-full p-2 border rounded" required>
                    <button type="submit" class="btn-primary w-full p-2 rounded">Guardar Docente</button>
                </form>
            </div>
        </div>
        
        <!-- Formulario Colaboradores -->
        <div id="form-container-colaborador" class="form-container hidden">
            <div class="card p-6 max-w-lg mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Registrar Nuevo Colaborador</h3>
                    <button type="button" class="back-to-selector-btn text-sm text-gray-500 hover:text-red-600">&larr; Volver</button>
                </div>
                <form id="form-colaborador" class="space-y-4">
                    <input type="text" name="nombreCompleto" placeholder="Nombre Completo" class="w-full p-2 border rounded" required>
                    <div class="grid grid-cols-3 gap-4">
                        <select name="tipoDocumento" class="w-full p-2 border rounded col-span-1">
                            <option value="DNI">DNI</option>
                            <option value="RUC">RUC</option>
                            <option value="Pasaporte">Pasaporte</option>
                            <option value="C.E.">C.E.</option>
                            <option value="CÃ©dula">CÃ©dula</option>
                        </select>
                        <input type="text" name="documentoIdentidad" placeholder="Nro. Documento" class="w-full p-2 border rounded col-span-2" required>
                    </div>
                    <div class="flex">
                        <select name="prefijo" class="p-2 border rounded-l-md bg-gray-50 border-r-0">
                            <option value="+51">ðŸ‡µðŸ‡ª +51</option>
                            <option value="+58">ðŸ‡»ðŸ‡ª +58</option>
                            <option value="+57">ðŸ‡¨ðŸ‡´ +57</option>
                            <option value="+52">ðŸ‡²ðŸ‡½ +52</option>
                            <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                            <option value="+34">ðŸ‡ªðŸ‡¸ +34</option>
                            <option value="+54">ðŸ‡¦ðŸ‡· +54</option>
                        </select>
                        <input type="tel" name="telefono" placeholder="TelÃ©fono" class="w-full p-2 border rounded-r-md" required>
                    </div>
                    <input type="email" name="email" placeholder="Email de Acceso" class="w-full p-2 border rounded" required>
                    <select name="rol" class="w-full p-2 border rounded" required>
                        <option value="" disabled selected>Seleccione un Rol</option>
                        <option value="Director Marketing">Director Marketing</option>
                        <option value="Soporte AcadÃ©mico">Soporte AcadÃ©mico</option>
                        <option value="Cobranzas">Cobranzas</option>
                        <option value="AtenciÃ³n Estudiantil">AtenciÃ³n Estudiantil</option>
                        <option value="AdministraciÃ³n y Presidencia">AdministraciÃ³n y Presidencia</option>
                        <option value="CoordinaciÃ³n AcadÃ©mica">CoordinaciÃ³n AcadÃ©mica</option>
                        <option value="DirecciÃ³n AcadÃ©mica">DirecciÃ³n AcadÃ©mica</option>
                        <option value="DiseÃ±o">DiseÃ±o</option>
                        <option value="Recursos Humanos">Recursos Humanos</option>
                        <option value="Calidad">Calidad</option>
                        <option value="Inscripciones">Inscripciones</option>
                    </select>
                    <button type="submit" class="btn-primary w-full p-2 rounded">Crear Colaborador y Generar Acceso</button>
                </form>
                <div id="password-display" class="hidden mt-4 p-4 bg-green-100 border border-green-200 rounded-md text-center">
                    <p class="font-semibold text-green-800">Â¡Acceso Creado! ContraseÃ±a temporal:</p>
                    <div class="my-2 p-2 bg-white rounded font-mono text-lg tracking-widest" id="generated-password"></div>
                    <p class="text-xs text-gray-600">Copia esta contraseÃ±a y compÃ¡rtela de forma segura. No se volverÃ¡ a mostrar.</p>
                </div>
            </div>
        </div>

        <!-- Formulario Alumnos -->
        <div id="form-container-alumno" class="form-container hidden">
            <div class="card p-6 max-w-lg mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Registrar Datos de Nuevo Alumno</h3>
                    <button type="button" class="back-to-selector-btn text-sm text-gray-500 hover:text-red-600">&larr; Volver</button>
                </div>
                <form id="form-alumno" class="space-y-4">
                    <input type="text" name="nombreCompleto" placeholder="Nombre Completo" class="w-full p-2 border rounded" required>
                    <div class="grid grid-cols-3 gap-4">
                        <select name="tipoDocumento" class="w-full p-2 border rounded col-span-1">
                            <option value="DNI">DNI</option>
                            <option value="RUC">RUC</option>
                            <option value="Pasaporte">Pasaporte</option>
                            <option value="C.E.">C.E.</option>
                            <option value="CÃ©dula">CÃ©dula</option>
                        </select>
                        <input type="text" name="documentoIdentidad" placeholder="Nro. Documento" class="w-full p-2 border rounded col-span-2" required>
                    </div>
                    <div class="flex">
                        <select name="prefijo" class="p-2 border rounded-l-md bg-gray-50 border-r-0">
                            <option value="+51">ðŸ‡µðŸ‡ª +51</option>
                            <option value="+58">ðŸ‡»ðŸ‡ª +58</option>
                            <option value="+57">ðŸ‡¨ðŸ‡´ +57</option>
                            <option value="+52">ðŸ‡²ðŸ‡½ +52</option>
                            <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                            <option value="+34">ðŸ‡ªðŸ‡¸ +34</option>
                            <option value="+54">ðŸ‡¦ðŸ‡· +54</option>
                        </select>
                        <input type="tel" name="telefono" placeholder="TelÃ©fono" class="w-full p-2 border rounded-r-md" required>
                    </div>
                    <input type="email" name="email" placeholder="Email" class="w-full p-2 border rounded" required>
                    <button type="submit" class="btn-primary w-full p-2 rounded">Guardar Alumno</button>
                </form>
            </div>
        </div>

        <!-- Formulario Aulas -->
        <div id="form-container-aula" class="form-container hidden">
            <div class="card p-6 max-w-lg mx-auto">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Registrar Nueva Aula</h3>
                    <button type="button" class="back-to-selector-btn text-sm text-gray-500 hover:text-red-600">&larr; Volver</button>
                </div>
                <form id="form-aula" class="space-y-4">
                    <input type="text" name="codigoAula" placeholder="CÃ³digo de Aula (ej: CH-GRL-01-A)" class="w-full p-2 border rounded" required>
                    <select name="nombreDocente" id="docente-select" class="w-full p-2 border rounded" required>
                        <option value="">Cargando docentes...</option>
                    </select>
                    <select name="tipoAula" id="tipo-aula-select" class="w-full p-2 border rounded">
                        <option value="CH-GRL" data-ciclos="12">Chino General</option>
                        <option value="CH-N" data-ciclos="6">Chino para NiÃ±os</option>
                        <option value="CH-P" data-ciclos="12">Chino Privado</option>
                        <option value="CH-C" data-ciclos="12">Chino Corporativo</option>
                        <option value="CI-C" data-ciclos="1">Importaciones Corto</option>
                        <option value="CI-L" data-ciclos="1">Importaciones Largo</option>
                        <option value="CE" data-ciclos="12">EspaÃ±ol</option>
                    </select>
                    <select name="ciclo" id="ciclo-aula-select" class="w-full p-2 border rounded" required>
                        <option value="">Seleccione un tipo de aula primero</option>
                    </select>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Frecuencia</label>
                        <div id="frecuencia-container" class="grid grid-cols-4 gap-2 mt-2"></div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Horario</label>
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <div>
                                <label for="start-time" class="text-xs">De:</label>
                                <div class="flex items-center gap-1">
                                    <select id="start-hour" class="w-full p-2 border rounded"></select>
                                    <select id="start-minute" class="w-full p-2 border rounded"></select>
                                    <select id="start-ampm" class="w-full p-2 border rounded"><option>AM</option><option>PM</option></select>
                                </div>
                            </div>
                            <div>
                                <label for="end-time" class="text-xs">A:</label>
                                <div class="flex items-center gap-1">
                                    <select id="end-hour" class="w-full p-2 border rounded"></select>
                                    <select id="end-minute" class="w-full p-2 border rounded"></select>
                                    <select id="end-ampm" class="w-full p-2 border rounded"><option>AM</option><option>PM</option></select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div><label class="text-sm">Fecha Inicio</label><input type="date" name="fechaInicio" class="w-full p-2 border rounded" required></div>
                    <div><label class="text-sm">Fecha Fin</label><input type="date" name="fechaFin" class="w-full p-2 border rounded" required></div>
                    <button type="submit" class="btn-primary w-full p-2 rounded">Guardar Aula</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, Timestamp, onSnapshot, query, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDC--X4Z95kEd7nd5X4P6B5yW6HPTiRxpQ",
            authDomain: "bdv3-ipch.firebaseapp.com",
            projectId: "bdv3-ipch",
            storageBucket: "bdv3-ipch.firebasestorage.app",
            messagingSenderId: "993842726107",
            appId: "1:993842726107:web:5e9d2b56f29238f2dc38fe"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const userCreationApp = initializeApp(firebaseConfig, "userCreationApp");
        const userCreationAuth = getAuth(userCreationApp);

        let dataCache = {
            docentes: []
        };

        function showNotification(message, type = 'success', duration = 5000) {
            window.parent.postMessage({ type: 'show-notification', message, messageType: type, duration }, '*');
        }

        function customConfirm(message) {
            return new Promise((resolve) => {
                const confirmId = Math.random().toString(36).substring(2, 15);
                const listener = (event) => {
                    if (event.data.type === 'confirm-result' && event.data.confirmId === confirmId) {
                        window.removeEventListener('message', listener);
                        resolve(event.data.result);
                    }
                };
                window.addEventListener('message', listener);
                window.parent.postMessage({ type: 'show-confirm', message, confirmId }, '*');
            });
        }
        
        const currentUserEmail = new URLSearchParams(window.location.search).get('user') || 'sistema@sgi.com';

        async function logAction(action, description) {
            try {
                await addDoc(collection(db, 'historialCambios'), {
                    fecha: Timestamp.now(),
                    usuario: currentUserEmail,
                    accion: action,
                    descripcion: description
                });
            } catch (error) {
                console.error("Error logging action:", error);
            }
        }

        const registroSelectorScreen = document.getElementById('registro-selector-screen');
        const registroSelect = document.getElementById('registro-select');
        const realizarRegistroBtn = document.getElementById('realizar-registro-btn');
        const formContainers = document.querySelectorAll('.form-container');

        function showSelectorScreen() {
            formContainers.forEach(container => container.classList.add('hidden'));
            registroSelectorScreen.classList.remove('hidden');
            formContainers.forEach(container => {
                const form = container.querySelector('form');
                if (form) form.reset();
                 const passwordDisplay = document.getElementById('password-display');
                if (passwordDisplay) passwordDisplay.classList.add('hidden');
            });
        }

        function showForm(registroTipo) {
            registroSelectorScreen.classList.add('hidden');
            formContainers.forEach(container => {
                container.classList.toggle('hidden', container.id !== `form-container-${registroTipo}`);
            });
        }
        
        document.getElementById('form-docente').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Guardando...';

            try {
                const formData = new FormData(form);
                const data = {
                    nombreCompleto: formData.get('nombreCompleto'),
                    tipoDocumento: formData.get('tipoDocumento'),
                    documentoIdentidad: formData.get('documentoIdentidad'),
                    telefono: `${formData.get('prefijo')} ${formData.get('telefono')}`,
                    email: formData.get('email')
                };
                const docRef = await addDoc(collection(db, 'docentes'), data);
                await logAction("CreaciÃ³n de Docente", `Se registrÃ³ al Docente: ${data.nombreCompleto} (ID: ${docRef.id})`);
                showNotification('Â¡Docente guardado exitosamente!', 'success');
                showSelectorScreen();
            } catch (error) {
                console.error("Error al guardar docente: ", error);
                showNotification(`Error al guardar: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Guardar Docente';
            }
        });

        document.getElementById('form-colaborador').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creando...';

            const passwordDisplay = document.getElementById('password-display');
            const passwordField = document.getElementById('generated-password');
            passwordDisplay.classList.add('hidden');

            const formData = new FormData(form);
            const email = formData.get('email');
            const rol = formData.get('rol');
            const tempPassword = Math.random().toString(36).slice(-8);

            const data = {
                nombreCompleto: formData.get('nombreCompleto'),
                tipoDocumento: formData.get('tipoDocumento'),
                documentoIdentidad: formData.get('documentoIdentidad'),
                telefono: `${formData.get('prefijo')} ${formData.get('telefono')}`,
                email: email,
                rol: rol,
                fechaCreacion: Timestamp.now()
            };
            
            const confirmed = await customConfirm(`Â¿Crear nuevo usuario para ${email} con el rol de ${rol}?`);
            if (!confirmed) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Crear Colaborador y Generar Acceso';
                return;
            }

            try {
                await createUserWithEmailAndPassword(userCreationAuth, email, tempPassword);
                await setDoc(doc(db, "usuarios", email), data);
                await logAction("CreaciÃ³n de Colaborador", `Se registrÃ³ al Colaborador: ${data.nombreCompleto} con rol ${data.rol}`);
                
                showNotification('Â¡Colaborador y acceso creados exitosamente!', 'success');
                passwordField.textContent = tempPassword;
                passwordDisplay.classList.remove('hidden');
                form.reset();
                // No llamamos a showSelectorScreen() para que se vea la contraseÃ±a. El usuario volverÃ¡ manualmente.

            } catch (error) {
                console.error("Error al crear colaborador: ", error);
                let friendlyMessage = "Error al crear el colaborador.";
                if (error.code === 'auth/email-already-in-use') {
                    friendlyMessage = "El correo electrÃ³nico ya estÃ¡ en uso por otro colaborador.";
                }
                showNotification(friendlyMessage, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Crear Colaborador y Generar Acceso';
            }
        });

        document.getElementById('form-alumno').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Guardando...';
            
            try {
                const formData = new FormData(form);
                const data = {
                    nombreCompleto: formData.get('nombreCompleto'),
                    tipoDocumento: formData.get('tipoDocumento'),
                    documentoIdentidad: formData.get('documentoIdentidad'),
                    telefono: `${formData.get('prefijo')} ${formData.get('telefono')}`,
                    email: formData.get('email'),
                    estado: "Registrado",
                    fechaRegistro: Timestamp.now(),
                    aulaActual: null,
                    cicloInscrito: null
                };
                const docRef = await addDoc(collection(db, 'alumnos'), data);
                await logAction("Registro de Alumno", `Se registraron los datos del alumno: ${data.nombreCompleto} (ID: ${docRef.id})`);
                showNotification('Â¡Alumno registrado! Ahora puede inscribirlo desde Gestiones.', 'info', 8000);
                showSelectorScreen();
            } catch (error) {
                console.error("Error al guardar alumno: ", error);
                showNotification(`Error al guardar: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Guardar Alumno';
            }
        });

        document.getElementById('form-aula').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Guardando...';

            try {
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => { if (value) data[key] = value; });

                if (data.ciclo) data.ciclo = parseInt(data.ciclo, 10);
                
                const diasSeleccionados = Array.from(document.querySelectorAll('#frecuencia-container input:checked')).map(cb => cb.value);
                data.frecuencia = diasSeleccionados.join(', ');
                const startHour = document.getElementById('start-hour').value;
                const startMinute = document.getElementById('start-minute').value;
                const startAmpm = document.getElementById('start-ampm').value;
                const endHour = document.getElementById('end-hour').value;
                const endMinute = document.getElementById('end-minute').value;
                const endAmpm = document.getElementById('end-ampm').value;
                data.horario = `${startHour}:${startMinute} ${startAmpm} - ${endHour}:${endMinute} ${endAmpm}`;
                data.fechaInicio = Timestamp.fromDate(new Date(data.fechaInicio + 'T00:00:00'));
                data.fechaFin = Timestamp.fromDate(new Date(data.fechaFin + 'T00:00:00'));
                data.cantidadAlumnos = 0;
                data.estado = "Programada";
                
                const docRef = await addDoc(collection(db, 'aulas'), data);
                await logAction("CreaciÃ³n de Aula", `Se registrÃ³ el Aula con cÃ³digo: ${data.codigoAula} (ID: ${docRef.id})`);
                showNotification('Â¡Aula guardada exitosamente!', 'success');
                showSelectorScreen();
            } catch (error) {
                console.error("Error al guardar aula: ", error);
                showNotification(`Error al guardar: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Guardar Aula';
            }
        });
        
        function populateDocentesDropdown() {
            const docenteSelect = document.getElementById('docente-select');
            docenteSelect.innerHTML = '<option value="">Seleccione un docente</option>';
            const docentes = dataCache.docentes.map(doc => doc.nombreCompleto).sort();
            docentes.forEach(nombre => {
                docenteSelect.innerHTML += `<option value="${nombre}">${nombre}</option>`;
            });
        }

        function setupAulaForm() {
            const tipoAulaSelect = document.getElementById('tipo-aula-select');
            const cicloAulaSelect = document.getElementById('ciclo-aula-select');
            
            function updateCiclos() {
                const selectedOption = tipoAulaSelect.options[tipoAulaSelect.selectedIndex];
                const maxCiclos = parseInt(selectedOption.dataset.ciclos) || 0;
                cicloAulaSelect.innerHTML = '<option value="">Seleccione un ciclo</option>';
                for (let i = 1; i <= maxCiclos; i++) {
                    cicloAulaSelect.innerHTML += `<option value="${i}">Ciclo ${i}</option>`;
                }
            }
            
            tipoAulaSelect.addEventListener('change', updateCiclos);
            updateCiclos();

            const dias = ['Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b', 'Dom'];
            const container = document.getElementById('frecuencia-container');
            dias.forEach(dia => {
                const label = document.createElement('label');
                label.className = 'flex items-center justify-center p-2 border rounded-md cursor-pointer has-[:checked]:bg-red-600 has-[:checked]:text-white transition-colors';
                label.innerHTML = `<input type="checkbox" value="${dia}" class="hidden"><span>${dia}</span>`;
                container.appendChild(label);
            });

            const hourSelects = [document.getElementById('start-hour'), document.getElementById('end-hour')];
            const minuteSelects = [document.getElementById('start-minute'), document.getElementById('end-minute')];
            
            hourSelects.forEach(select => {
                for(let i=1; i<=12; i++) {
                    const val = i.toString().padStart(2, '0');
                    select.innerHTML += `<option value="${val}">${val}</option>`;
                }
            });
            minuteSelects.forEach(select => {
                for(let i=0; i<60; i+=5) {
                    const val = i.toString().padStart(2, '0');
                    select.innerHTML += `<option value="${val}">${val}</option>`;
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const userName = new URLSearchParams(window.location.search).get('userName') || 'Colaborador';
            const userRole = new URLSearchParams(window.location.search).get('role');
            document.getElementById('registro-greeting').textContent = `Hola, ${userName.split(' ')[0]}!`;

            if (userRole === 'Cobranzas') {
                showForm('alumno');
                registroSelectorScreen.classList.add('hidden');
                // Ocultar el botÃ³n de volver para este rol especÃ­fico si es necesario
                document.querySelector('#form-container-alumno .back-to-selector-btn').classList.add('hidden');
            } else {
                 if (userRole !== 'Director Marketing') {
                    const colaboradorOption = registroSelect.querySelector('option[value="colaborador"]');
                    if (colaboradorOption) colaboradorOption.remove();
                }
                showSelectorScreen();
            }

            onSnapshot(collection(db, 'docentes'), (snapshot) => {
                dataCache.docentes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateDocentesDropdown();
            });

            setupAulaForm();
            
            realizarRegistroBtn.addEventListener('click', () => {
                showForm(registroSelect.value);
            });

            document.querySelectorAll('.back-to-selector-btn').forEach(btn => {
                btn.addEventListener('click', showSelectorScreen);
            });
        });
    </script>
</body>
</html>