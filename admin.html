<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo de Administraci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-gray-100 p-6 md:p-10">

    <div class="max-w-6xl mx-auto">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">Panel de Administraci√≥n</h2>
        
        <!-- Selector de Herramientas -->
        <div id="admin-tool-selector-screen" class="card p-8 text-center">
            <h3 id="admin-greeting" class="text-2xl font-bold text-gray-800 mb-2"></h3>
            <p class="text-gray-600 mb-6">Selecciona la herramienta administrativa que deseas utilizar.</p>
            <div class="flex flex-col sm:flex-row items-center gap-4 justify-center">
                <select id="admin-tool-select" class="w-full max-w-md p-3 border rounded-md shadow-sm focus:border-red-500 focus:ring-1 focus:ring-red-500">
                    <option value="global_history">üìú Visor de Historial Global (Optimizado)</option>
                    <option value="maintenance">üîí Control de Mantenimiento</option>
                    <option value="revert_last_management">‚Ü©Ô∏è Revertir Gesti√≥n (Renov/Traslado) [MOVIDO]</option>
                    <option value="revert_pause_retire">‚èØÔ∏è Revertir Pausa o Retiro [NUEVO]</option>
                    <option value="assignment_correction">üõ†Ô∏è Correcci√≥n de Asignaci√≥n de Aula</option>
                    <option value="clear_note">üìù Limpiar Nota de Historial</option>
                    <option value="recover_aula">‚ôªÔ∏è Recuperar Aula Cerrada</option>
                    <option value="revert_egreso">üéì Revertir Egreso</option>
                    <option value="revert_reincorporacion">‚Ü©Ô∏è Revertir Reincorporaci√≥n</option>
                    <option value="revert_inscripcion">‚ùå Revertir Inscripci√≥n</option>
                    <option value="process_transfer">‚úàÔ∏è Procesar Traslado Manual</option>
                    <option value="delete_record">üóëÔ∏è Borrado Espec√≠fico</option>
                </select>
                <button id="go-to-tool-btn" class="btn-primary font-semibold py-3 px-6 rounded-md w-full sm:w-auto whitespace-nowrap shadow-md transform transition hover:scale-105">Ir a Herramienta</button>
            </div>
        </div>

        <div id="admin-tools-container" class="hidden">
            <!-- Bot√≥n para volver al selector -->
            <button id="back-to-selector-btn" class="mb-6 text-sm text-gray-600 hover:text-red-700 font-semibold flex items-center transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Volver a la selecci√≥n de herramientas
            </button>

            <!-- 1. Visor de Historial Global (OPTIMIZADO + BUSCADOR) -->
            <div id="tool-container-global_history" class="admin-tool-form card p-6 hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 border-b pb-4 gap-4">
                    <h4 class="font-bold text-xl text-gray-800">Historial Global del Sistema</h4>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <input type="text" id="history-search-input" placeholder="Buscar usuario, acci√≥n, descripci√≥n..." class="p-2 border rounded text-sm w-full sm:w-64 focus:ring-2 focus:ring-blue-500 outline-none">
                        <button id="history-search-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-bold transition-colors"><i class="fas fa-search"></i></button>
                        <button id="refresh-history-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded text-sm transition-colors" title="Recargar"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
                
                <div id="search-status-bar" class="hidden mb-4 p-2 bg-yellow-50 text-yellow-800 text-sm rounded border border-yellow-200 flex justify-between items-center">
                    <span id="search-status-text">Buscando en registros antiguos...</span>
                    <button id="stop-search-btn" class="text-red-600 font-bold hover:text-red-800 text-xs uppercase">Detener B√∫squeda</button>
                </div>

                <p class="text-sm text-gray-500 mb-4 bg-blue-50 p-2 rounded border border-blue-100"><i class="fas fa-info-circle mr-1"></i> Mostrando los √∫ltimos movimientos. Usa el buscador para encontrar eventos espec√≠ficos en todo el historial.</p>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-100 text-gray-700 uppercase text-xs tracking-wider">
                            <tr>
                                <th class="p-3">Fecha</th>
                                <th class="p-3">Usuario</th>
                                <th class="p-3">Acci√≥n</th>
                                <th class="p-3">Descripci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="global-history-tbody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
                <div class="mt-6 text-center">
                    <button id="load-more-history-btn" class="text-blue-600 hover:text-blue-800 font-semibold text-sm py-2 px-4 border border-blue-200 rounded hover:bg-blue-50 transition-colors">
                        Cargar m√°s registros antiguos...
                    </button>
                    <p id="history-end-msg" class="hidden text-gray-400 text-sm italic mt-2">No hay m√°s registros disponibles.</p>
                </div>
            </div>

            <!-- 2. Modo Mantenimiento (CORREGIDO) -->
            <div id="tool-container-maintenance" class="admin-tool-form card p-8 hidden">
                <h4 class="font-bold text-lg text-gray-800 mb-4">Control de Acceso y Mantenimiento</h4>
                <div class="mb-8 p-4 rounded-lg transition-all" id="maintenance-status-banner">
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div>
                            <h4 class="font-bold text-lg" id="maintenance-status-title">Estado del Sistema</h4>
                            <p class="text-sm mt-1" id="maintenance-status-text">Cargando estado actual...</p>
                        </div>
                        <button id="toggle-maintenance-btn" class="font-bold py-2 px-5 rounded-md transition-colors disabled:opacity-50 shadow-sm" disabled>
                            Cargando...
                        </button>
                    </div>
                </div>
                
                <div class="bg-white border rounded-lg p-4">
                    <h4 class="font-bold text-gray-700 mb-3 flex items-center"><i class="fas fa-users mr-2 text-indigo-500"></i> Colaboradores Conectados (√öltimos 2 min)</h4>
                    <div id="online-users-container" class="space-y-2 max-h-60 overflow-y-auto">
                        <p class="text-center text-gray-500 py-4 italic">Esperando datos de presencia...</p>
                    </div>
                </div>
            </div>
            
            <!-- 3. Revertir √öltima Gesti√≥n (Movido) -->
            <div id="tool-container-revert_last_management" class="admin-tool-form card p-8 hidden">
                <h4 class="font-bold text-lg text-gray-800 mb-2">Revertir √öltima Gesti√≥n (Renovaci√≥n/Traslado)</h4>
                <p class="text-sm text-gray-500 mb-4">Busca al alumno para anular su √∫ltima gesti√≥n pendiente (ej. si se renov√≥ por error).</p>
                <div class="space-y-4 bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <input type="text" id="search-revert-last" placeholder="Buscar alumno activo por nombre..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-200 outline-none">
                    <div id="results-revert-last" class="max-h-48 overflow-y-auto bg-white rounded border border-gray-200 hidden"></div>
                    
                    <div id="revert-last-details-container" class="hidden mt-6 p-4 border bg-white rounded-md">
                        <p class="font-bold text-gray-800 mb-2">Detalles de la gesti√≥n encontrada:</p>
                        <div id="revert-last-info" class="text-sm space-y-2 mb-4 text-gray-600"></div>
                        <div id="revert-last-no-action" class="hidden text-center text-gray-500 italic p-4">No se encontraron gestiones pendientes para revertir.</div>
                        <button type="button" id="confirm-revert-last-btn" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-md shadow transition-colors hidden">Confirmar Reversi√≥n Completa</button>
                    </div>
                </div>
            </div>

            <!-- 4. Revertir Pausa/Retiro -->
            <div id="tool-container-revert_pause_retire" class="admin-tool-form card p-8 hidden">
                <h4 class="font-bold text-lg text-gray-800 mb-2">Revertir Pausa o Retiro</h4>
                <p class="text-sm text-gray-500 mb-4">Restaura a un alumno pausado/retirado a su aula anterior para gestionar su renovaci√≥n.</p>
                <div class="space-y-4 bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <input type="text" id="search-revert-pause" placeholder="Buscar alumno (Pausado/Retirado)..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-green-200 outline-none">
                    <div id="results-revert-pause" class="max-h-48 overflow-y-auto bg-white rounded border border-gray-200 hidden"></div>
                    
                    <div id="revert-pause-form" class="hidden mt-6 space-y-4 border-t pt-4">
                        <p class="text-sm text-gray-600">Restaurar estado para:</p>
                        <p class="font-bold text-xl text-green-800" id="student-revert-pause-name"></p>
                        <div id="revert-pause-details" class="p-4 border bg-white rounded-md text-sm shadow-sm"></div>
                        <button type="button" id="confirm-revert-pause-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-md shadow transition-colors">Confirmar y Restaurar a Pendiente</button>
                    </div>
                </div>
            </div>

            <!-- 5. Revertir Reincorporaci√≥n -->
            <div id="tool-container-revert_reincorporacion" class="admin-tool-form card p-8 hidden">
                <h4 class="font-bold text-lg text-gray-800 mb-2">Revertir √öltima Reincorporaci√≥n</h4>
                <p class="text-sm text-gray-500 mb-4">Anula la √∫ltima reincorporaci√≥n de un alumno, devolvi√©ndolo a estado 'Pausado' o 'Retirado'.</p>
                <div class="space-y-4 bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <input type="text" id="search-student-revert-reinc" placeholder="Buscar alumno activo por nombre..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-orange-200 outline-none">
                    <div id="student-revert-reinc-results" class="max-h-48 overflow-y-auto bg-white rounded border border-gray-200 hidden"></div>
                    
                    <div id="revert-reinc-form" class="hidden mt-6 space-y-4 border-t pt-4">
                        <p class="text-sm text-gray-600">Revertir acci√≥n para:</p>
                        <p class="font-bold text-xl text-orange-700" id="student-revert-reinc-name"></p>
                        <div id="revert-reinc-details" class="p-4 border bg-white rounded-md text-sm shadow-sm"></div>
                        <button type="button" id="revert-reinc-btn" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-4 rounded-md shadow transition-colors">Confirmar y Revertir Reincorporaci√≥n</button>
                    </div>
                </div>
            </div>

            <!-- 6. Revertir Inscripci√≥n -->
            <div id="tool-container-revert_inscripcion" class="admin-tool-form card p-8 hidden">
                <h4 class="font-bold text-lg text-gray-800 mb-2">Revertir √öltima Inscripci√≥n</h4>
                <p class="text-sm text-gray-500 mb-4">Anula la inscripci√≥n inicial de un alumno, devolvi√©ndolo a estado 'Registrado'.</p>
                <div class="space-y-4 bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <input type="text" id="search-student-revert-insc" placeholder="Buscar alumno activo por nombre..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-purple-200 outline-none">
                    <div id="student-revert-insc-results" class="max-h-48 overflow-y-auto bg-white rounded border border-gray-200 hidden"></div>
                    
                    <div id="revert-insc-form" class="hidden mt-6 space-y-4 border-t pt-4">
                        <p class="text-sm text-gray-600">Revertir acci√≥n para:</p>
                        <p class="font-bold text-xl text-purple-800" id="student-revert-insc-name"></p>
                        <div id="revert-insc-details" class="p-4 border bg-white rounded-md text-sm shadow-sm"></div>
                        <button type="button" id="revert-insc-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-md shadow transition-colors">Confirmar y Revertir Inscripci√≥n</button>
                    </div>
                </div>
            </div>

            <!-- 7. Limpiar Nota -->
            <div id="tool-container-clear_note" class="admin-tool-form card p-8 hidden">
                <h4 class="font-bold text-lg text-gray-800 mb-2">Limpiar Nota de Historial</h4>
                <p class="text-sm text-gray-500 mb-4">Elimina una nota final registrada incorrectamente en el historial de transacciones.</p>
                <div class="space-y-4 bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <input type="text" id="search-student-history" placeholder="Buscar alumno por nombre..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-200 outline-none">
                    <div id="student-history-results" class="max-h-48 overflow-y-auto bg-white rounded border border-gray-200 hidden"></div>
                    <div id="history-records-container" class="hidden mt-4 space-y-2"></div>
                </div>
            </div>

            <!-- 8. Recuperar Aula -->
            <div id="tool-container-recover_aula" class="admin-tool-form card p-8 hidden">
                <h4 class="font-bold text-lg text-gray-800 mb-2">Recuperar Aula Cerrada</h4>
                <p class="text-sm text-gray-500 mb-4">Restaura un aula que fue cerrada y archivada, devolvi√©ndola a la lista de aulas activas.</p>
                <div class="space-y-4 bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <input type="text" id="search-aula-recover" placeholder="Buscar por c√≥digo de aula (Ej: CH-GRL)..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-green-200 outline-none">
                    <div id="aula-recover-results" class="max-h-48 overflow-y-auto bg-white rounded border border-gray-200 hidden"></div>
                    <div id="aula-recover-form" class="hidden mt-4 space-y-4">
                        <p class="text-sm text-gray-600">Restaurar la siguiente aula:</p>
                        <p class="font-bold text-xl text-green-800" id="aula-recover-name"></p>
                        <button type="button" id="recover-aula-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-md shadow transition-colors">Confirmar y Restaurar Aula</button>
                    </div>
                </div>
            </div>

            <!-- 9. Revertir Egreso -->
            <div id="tool-container-revert_egreso" class="admin-tool-form card p-8 hidden">
                <h4 class="font-bold text-lg text-gray-800 mb-2">Revertir Egreso de Alumno</h4>
                <p class="text-sm text-gray-500 mb-4">Devuelve a un alumno 'Egresado' al estado 'Activo'.</p>
                <div class="space-y-4 bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <input type="text" id="search-student-revert" placeholder="Buscar alumno egresado..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-red-200 outline-none">
                    <div id="student-revert-results" class="max-h-48 overflow-y-auto bg-white rounded border border-gray-200 hidden"></div>
                    
                    <div id="student-revert-form" class="hidden mt-4 space-y-4">
                        <p class="text-sm text-gray-600">Revertir egreso para:</p>
                        <p class="font-bold text-xl text-red-800" id="student-revert-name"></p>
                        <button type="button" id="revert-egreso-btn" class="w-full danger-btn">Revertir Egreso</button>
                    </div>
                </div>
            </div>

            <!-- 10. Correcci√≥n Asignaci√≥n -->
            <div id="tool-container-assignment_correction" class="admin-tool-form card p-8 hidden">
                <h4 class="font-bold text-lg text-gray-800 mb-2">Correcci√≥n de Asignaci√≥n de Aula</h4>
                <p class="text-sm text-gray-500 mb-4">Mueve a un alumno de aula sin generar registro financiero. Solo para correcciones administrativas.</p>
                <div class="space-y-4 bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <input type="text" id="search-student-correction" placeholder="Buscar alumno..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-200 outline-none">
                    <div id="student-correction-results" class="max-h-48 overflow-y-auto bg-white rounded border border-gray-200 hidden"></div>
                    
                    <div id="student-correction-form" class="hidden mt-4 space-y-4">
                        <p class="font-bold text-xl text-blue-800" id="student-correction-name"></p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700">Aula Actual:</label><p id="current-aula-display" class="p-2 bg-gray-200 rounded-md text-sm mt-1"></p></div>
                            <div><label class="block text-sm font-medium text-gray-700">Nueva Aula Correcta:</label><select id="new-aula-select" class="w-full p-2 border rounded-md mt-1"></select></div>
                        </div>
                        <button type="button" id="correct-assignment-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-md shadow transition-colors">Aplicar Correcci√≥n</button>
                    </div>
                </div>
            </div>
            
            <!-- 11. Procesar Traslado -->
            <div id="tool-container-process_transfer" class="admin-tool-form card p-8 hidden">
                <h4 class="font-bold text-lg text-gray-800 mb-2">Procesar Traslado Pendiente Manualmente</h4>
                <p class="text-sm text-gray-500 mb-4">Fuerza la ejecuci√≥n de un traslado que qued√≥ pendiente.</p>
                <div class="space-y-4 bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <input type="text" id="search-pending-transfer" placeholder="Buscar alumno con traslado pendiente..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-200 outline-none">
                    <div id="pending-transfer-results" class="max-h-48 overflow-y-auto bg-white rounded border border-gray-200 hidden"></div>
                    <div id="pending-transfer-form" class="hidden mt-4 space-y-4">
                        <div class="p-4 border bg-white rounded-md shadow-sm">
                            <p class="font-bold text-lg text-indigo-800" id="pending-transfer-name"></p>
                            <div class="flex gap-4 mt-2 text-sm text-gray-600">
                                <span><strong>De:</strong> <span id="pending-transfer-origin"></span></span>
                                <i class="fas fa-arrow-right self-center"></i>
                                <span><strong>A:</strong> <span id="pending-transfer-destination"></span></span>
                            </div>
                        </div>
                        <button type="button" id="process-transfer-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-md shadow transition-colors">Procesar Traslado Ahora</button>
                    </div>
                </div>
            </div>

            <!-- 12. Borrado Espec√≠fico -->
            <div id="tool-container-delete_record" class="admin-tool-form card p-8 hidden">
                <h4 class="font-bold text-lg text-gray-800 mb-2">Borrado Espec√≠fico de Registros</h4>
                <p class="text-sm text-red-500 mb-4 font-semibold"><i class="fas fa-exclamation-triangle"></i> ¬°Cuidado! Esta acci√≥n elimina registros permanentemente.</p>
                <div class="space-y-4 bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <select id="delete-type-select" class="w-full p-2 border rounded-md"><option value="alumnos">Alumno</option><option value="docentes">Docente</option><option value="aulas">Aula</option><option value="usuarios">Colaborador</option></select>
                        <input type="text" id="search-specific-input" placeholder="Buscar registro..." class="w-full p-2 border rounded-md">
                    </div>
                    <div id="search-specific-results" class="max-h-48 overflow-y-auto"></div>
                    <div id="record-to-delete-container" class="hidden mt-4 p-4 border-l-4 border-red-500 bg-red-50 rounded-r-md">
                        <p class="font-bold text-lg text-red-800" id="record-name-display"></p>
                        <button type="button" id="delete-specific-btn" class="w-full mt-4 danger-btn">Eliminar Permanentemente</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, auth } from "./js/firebase-config.js";
        import { collection, getDocs, doc, query, where, addDoc, Timestamp, updateDoc, deleteDoc, runTransaction, orderBy, limit, startAfter, setDoc, onSnapshot, getDoc, deleteField, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { safeToDate, showNotification, customConfirm, logAction, getQueryParam } from "./js/utils.js";

        document.addEventListener('DOMContentLoaded', () => {
            const userName = getQueryParam('userName') || 'Admin';
            document.getElementById('admin-greeting').textContent = `Hola, ${userName.split(' ')[0]}!`;
            
            let dataCache = { alumnos: [], aulas: [], trasladosPendientes: [], historialCarteras: [], usuarios: [], docentes: [] };
            let lastHistoryDoc = null;
            let isHistoryLoading = false;
            const HISTORY_BATCH_SIZE = 20;

            const collectionsToCache = ['alumnos', 'aulas', 'trasladosPendientes', 'historialCarteras', 'usuarios', 'docentes'];
            collectionsToCache.forEach(name => {
                onSnapshot(collection(db, name), snapshot => {
                    dataCache[name] = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                });
            });

            // UI Elements
            const selectorScreen = document.getElementById('admin-tool-selector-screen');
            const toolsContainer = document.getElementById('admin-tools-container');
            const toolSelect = document.getElementById('admin-tool-select');
            
            function showTool(toolName) {
                selectorScreen.classList.add('hidden');
                toolsContainer.classList.remove('hidden');
                document.querySelectorAll('.admin-tool-form').forEach(form => {
                    form.classList.toggle('hidden', form.id !== `tool-container-${toolName}`);
                });
                if (toolName === 'global_history') {
                    document.getElementById('global-history-tbody').innerHTML = '';
                    lastHistoryDoc = null;
                    loadGlobalHistory();
                }
            }

            document.getElementById('go-to-tool-btn').addEventListener('click', () => showTool(toolSelect.value));
            document.getElementById('back-to-selector-btn').addEventListener('click', () => {
                toolsContainer.classList.add('hidden');
                selectorScreen.classList.remove('hidden');
            });

            // --- 1. Historial Global ---
            const historyTbody = document.getElementById('global-history-tbody');
            const loadMoreBtn = document.getElementById('load-more-history-btn');
            const historyEndMsg = document.getElementById('history-end-msg');
            const searchInput = document.getElementById('history-search-input');
            const searchStatus = document.getElementById('search-status-bar');
            const searchStatusText = document.getElementById('search-status-text');
            
            let isSearching = false;
            let searchStopRequested = false;

            function renderHistoryRow(doc) {
                const d = doc.data();
                const accion = d.accion || d.action || '<span class="text-gray-400 italic">Desconocida</span>';
                const descripcion = d.descripcion || d.description || '<span class="text-gray-400 italic">Sin detalles</span>';
                const usuario = d.usuario || 'Sistema';
                const fecha = safeToDate(d.fecha)?.toLocaleString('es-PE') || 'Fecha inv√°lida';

                const row = document.createElement('tr');
                row.className = "border-b hover:bg-gray-50 transition-colors";
                row.innerHTML = `
                    <td class="p-3 text-xs text-gray-500 whitespace-nowrap">${fecha}</td>
                    <td class="p-3 text-sm font-medium text-blue-600 truncate max-w-[150px]" title="${usuario}">${usuario}</td>
                    <td class="p-3 text-sm font-bold text-gray-700">${accion}</td>
                    <td class="p-3 text-sm text-gray-600">${descripcion}</td>
                `;
                return row;
            }

            async function loadGlobalHistory() {
                if (isHistoryLoading) return;
                isHistoryLoading = true;
                loadMoreBtn.textContent = "Cargando...";
                loadMoreBtn.disabled = true;
                
                try {
                    let q = query(collection(db, "historialCambios"), orderBy("fecha", "desc"), limit(HISTORY_BATCH_SIZE));
                    if (lastHistoryDoc) {
                        q = query(collection(db, "historialCambios"), orderBy("fecha", "desc"), startAfter(lastHistoryDoc), limit(HISTORY_BATCH_SIZE));
                    }
                    
                    const snapshot = await getDocs(q);
                    if (!lastHistoryDoc) historyTbody.innerHTML = ''; 
                    snapshot.forEach(doc => historyTbody.appendChild(renderHistoryRow(doc)));

                    if (snapshot.empty || snapshot.size < HISTORY_BATCH_SIZE) {
                        loadMoreBtn.classList.add('hidden');
                        historyEndMsg.classList.remove('hidden');
                        if(historyTbody.children.length === 0) historyTbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">No hay registros.</td></tr>';
                    } else {
                        lastHistoryDoc = snapshot.docs[snapshot.docs.length - 1];
                        loadMoreBtn.classList.remove('hidden');
                        historyEndMsg.classList.add('hidden');
                    }
                } catch(e) { console.error(e); showNotification("Error al cargar historial", "error"); }
                finally { 
                    isHistoryLoading = false; 
                    loadMoreBtn.textContent = "Cargar m√°s registros antiguos..."; 
                    loadMoreBtn.disabled = false;
                }
            }

            async function performSearch(term) {
                if (!term) return;
                isSearching = true;
                searchStopRequested = false;
                historyTbody.innerHTML = '';
                loadMoreBtn.classList.add('hidden');
                historyEndMsg.classList.add('hidden');
                searchStatus.classList.remove('hidden');
                
                let searchLastDoc = null;
                let foundCount = 0;
                let scannedCount = 0;
                const BATCH_SIZE = 50; 
                const MAX_SCANS = 2000;

                try {
                    while (!searchStopRequested && scannedCount < MAX_SCANS) {
                        searchStatusText.textContent = `Escaneando historial... (${scannedCount} registros revisados)`;
                        let q = query(collection(db, "historialCambios"), orderBy("fecha", "desc"), limit(BATCH_SIZE));
                        if (searchLastDoc) q = query(collection(db, "historialCambios"), orderBy("fecha", "desc"), startAfter(searchLastDoc), limit(BATCH_SIZE));

                        const snapshot = await getDocs(q);
                        if (snapshot.empty) break;

                        snapshot.forEach(doc => {
                            const d = doc.data();
                            const searchableText = `${d.usuario} ${d.accion || d.action} ${d.descripcion || d.description}`.toLowerCase();
                            if (searchableText.includes(term)) {
                                historyTbody.appendChild(renderHistoryRow(doc));
                                foundCount++;
                            }
                        });
                        searchLastDoc = snapshot.docs[snapshot.docs.length - 1];
                        scannedCount += snapshot.size;
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                    searchStatus.classList.add('hidden');
                    if (foundCount === 0) {
                        historyTbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-500">No se encontraron resultados para "${term}" en los √∫ltimos ${scannedCount} registros.</td></tr>`;
                    } else {
                        historyEndMsg.textContent = `B√∫squeda finalizada. Se encontraron ${foundCount} coincidencias en ${scannedCount} registros.`;
                        historyEndMsg.classList.remove('hidden');
                    }
                } catch (e) { console.error("Error en b√∫squeda:", e); showNotification("Error durante la b√∫squeda.", "error"); } 
                finally { isSearching = false; }
            }

            document.getElementById('history-search-btn').addEventListener('click', () => {
                const term = searchInput.value.trim().toLowerCase();
                if (term) performSearch(term);
                else { lastHistoryDoc = null; loadGlobalHistory(); }
            });
            searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') document.getElementById('history-search-btn').click(); });
            document.getElementById('stop-search-btn').addEventListener('click', () => { searchStopRequested = true; searchStatusText.textContent = "Deteniendo b√∫squeda..."; });
            document.getElementById('refresh-history-btn').addEventListener('click', () => { searchInput.value = ''; lastHistoryDoc = null; searchStatus.classList.add('hidden'); loadGlobalHistory(); });
            document.getElementById('load-more-history-btn').addEventListener('click', loadGlobalHistory);

            // --- 2. Modo Mantenimiento (CORREGIDO) ---
            const statusBanner = document.getElementById('maintenance-status-banner');
            const statusTitle = document.getElementById('maintenance-status-title');
            const statusText = document.getElementById('maintenance-status-text');
            const toggleBtn = document.getElementById('toggle-maintenance-btn');
            const systemStatusRef = doc(db, "systemInfo", "status");
            const onlineUsersContainer = document.getElementById('online-users-container');

            // Listener de estado de mantenimiento
            onSnapshot(systemStatusRef, (docSnap) => {
                toggleBtn.disabled = false; // Habilitar el bot√≥n
                toggleBtn.textContent = "Cargando...";
                
                const isMaintenance = docSnap.exists() && docSnap.data().maintenanceMode;
                const allowedUser = docSnap.exists() ? docSnap.data().allowedUser : null;

                if (isMaintenance) {
                    statusBanner.className = 'mb-8 p-4 rounded-lg bg-red-100 border border-red-200';
                    statusTitle.className = 'font-bold text-lg text-red-800';
                    statusTitle.textContent = '¬°Modo Mantenimiento ACTIVO!';
                    statusText.textContent = `Activado por: ${allowedUser || 'Admin'}. Solo este usuario tiene acceso.`;
                    toggleBtn.textContent = 'DESACTIVAR MODO';
                    toggleBtn.className = 'font-bold py-2 px-5 rounded-md transition-colors bg-red-600 hover:bg-red-700 text-white shadow-sm';
                } else {
                    statusBanner.className = 'mb-8 p-4 rounded-lg bg-green-100 border border-green-200';
                    statusTitle.className = 'font-bold text-lg text-green-800';
                    statusTitle.textContent = 'Sistema Operativo';
                    statusText.textContent = 'El acceso est√° habilitado para todos los colaboradores.';
                    toggleBtn.textContent = 'ACTIVAR MANTENIMIENTO';
                    toggleBtn.className = 'font-bold py-2 px-5 rounded-md transition-colors bg-yellow-500 hover:bg-yellow-600 text-white shadow-sm';
                }
                
                toggleBtn.onclick = async () => {
                    const confirmMsg = isMaintenance 
                        ? "¬øDesactivar el mantenimiento? Todos los usuarios podr√°n ingresar." 
                        : `¬øActivar modo mantenimiento? SOLO T√ö (${userName}) tendr√°s acceso.`;
                    
                    if(await customConfirm(confirmMsg)) {
                        await setDoc(systemStatusRef, { maintenanceMode: !isMaintenance, allowedUser: !isMaintenance ? getQueryParam('user') : null });
                    }
                };
            });

            // Listener de Usuarios Conectados
            const twoMinutesAgo = new Date(Date.now() - 2 * 60 * 1000);
            const presenceQuery = query(collection(db, 'user_presence'), where('last_seen', '>', Timestamp.fromDate(twoMinutesAgo)));

            onSnapshot(presenceQuery, (snapshot) => {
                onlineUsersContainer.innerHTML = '';
                const onlineUsers = snapshot.docs.map(doc => doc.data()).filter(user => user.status === 'online');

                if (onlineUsers.length === 0) {
                    onlineUsersContainer.innerHTML = '<p class="text-center text-gray-500 py-4 italic">Nadie est√° conectado en este momento.</p>';
                    return;
                }

                onlineUsers.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'flex items-center gap-3 p-2 bg-gray-50 rounded-md border border-gray-100 mb-2';
                    userDiv.innerHTML = `
                        <i class="fas fa-circle text-green-500 text-xs"></i>
                        <div>
                            <p class="font-semibold text-sm text-gray-800">${user.userName || 'Usuario'}</p>
                            <p class="text-xs text-gray-500">${user.userRole || 'Sin rol'}</p>
                        </div>
                    `;
                    onlineUsersContainer.appendChild(userDiv);
                });
            });

            // --- 3. Revertir √öltima Gesti√≥n (REPARADA) ---
            const searchRevertLast = document.getElementById('search-revert-last');
            const resultsRevertLast = document.getElementById('results-revert-last');
            const detailsRevertLast = document.getElementById('revert-last-details-container');
            let selectedStudentRevertLast = null;
            let actionToRevert = null;

            setupToolSearch('search-revert-last', 'results-revert-last', 'alumnos', (s) => {
                selectedStudentRevertLast = s;
                checkRevertOptions(s);
            }, s => s.estado === 'Activo' || s.estado.includes('Traslado'));

            function checkRevertOptions(student) {
                detailsRevertLast.classList.remove('hidden');
                document.getElementById('revert-last-info').innerHTML = '<div class="loader"></div>';
                document.getElementById('confirm-revert-last-btn').classList.add('hidden');
                document.getElementById('revert-last-no-action').classList.add('hidden');

                // L√≥gica mejorada para detectar traslados y renovaciones recientes
                // 1. Buscar en trasladosPendientes (si a√∫n est√° pendiente)
                const trasladoPendiente = dataCache.trasladosPendientes.find(t => t.alumnoId === student.id && t.estado === "Pendiente");
                
                // 2. Buscar en historialAlumnos (para renovaciones o traslados ya completados)
                const qHistorial = query(collection(db, "historialAlumnos"), 
                    where("alumnoId", "==", student.id), 
                    where("tipoAccion", "in", ["Renovaci√≥n", "Traslado por Cobro", "Traslado Acad√©mico"]), 
                    orderBy("fecha", "desc"), 
                    limit(1)
                );
                
                getDocs(qHistorial).then(snap => {
                    actionToRevert = null;

                    if (trasladoPendiente) {
                        actionToRevert = { type: 'Traslado (Pendiente)', data: trasladoPendiente, id: trasladoPendiente.id, source: 'trasladosPendientes' };
                    } else if (!snap.empty) {
                        const histData = snap.docs[0].data();
                        const histId = snap.docs[0].id;
                        // Validamos si la acci√≥n es reciente y corresponde al ciclo actual del alumno para evitar borrar historia antigua
                        const esReciente = (Date.now() - histData.fecha.toMillis()) < (7 * 24 * 60 * 60 * 1000); // 7 d√≠as de margen
                        
                        if (esReciente) {
                            if (histData.tipoAccion === 'Renovaci√≥n') {
                                actionToRevert = { type: 'Renovaci√≥n', data: histData, id: histId, source: 'historialAlumnos' };
                            } else if (histData.tipoAccion.includes('Traslado')) {
                                actionToRevert = { type: 'Traslado (Completado)', data: histData, id: histId, source: 'historialAlumnos' };
                            }
                        }
                    }

                    if (actionToRevert) {
                        let infoHtml = `<p><strong>Acci√≥n encontrada:</strong> ${actionToRevert.type}</p>`;
                        if (actionToRevert.type === 'Renovaci√≥n') {
                            infoHtml += `<p>Se anular√° la renovaci√≥n al ciclo ${actionToRevert.data.detalles?.ciclo || '?'}.</p>`;
                        } else {
                            const aulaDest = actionToRevert.data.aulaDestino || actionToRevert.data.detalles?.aulaDestino;
                            infoHtml += `<p>Se revertir√° el traslado hacia ${aulaDest}. El alumno volver√° a su aula anterior.</p>`;
                        }
                        
                        document.getElementById('revert-last-info').innerHTML = infoHtml;
                        document.getElementById('confirm-revert-last-btn').classList.remove('hidden');
                    } else {
                        document.getElementById('revert-last-info').innerHTML = '';
                        document.getElementById('revert-last-no-action').classList.remove('hidden');
                    }
                });
            }

            document.getElementById('confirm-revert-last-btn').addEventListener('click', async () => {
                if(!selectedStudentRevertLast || !actionToRevert) return;
                if(!await customConfirm("¬øEst√°s seguro de REVERTIR esta gesti√≥n? Se borrar√°n pagos asociados y se restaurar√° el estado anterior.")) return;

                try {
                    await runTransaction(db, async (t) => {
                        // --- FASE 1: LECTURAS (READS) ---
                        const sRef = doc(db, "alumnos", selectedStudentRevertLast.id);
                        const sDoc = await t.get(sRef);
                        
                        if (!sDoc.exists()) throw "Alumno no encontrado";
                        const currentData = sDoc.data();

                        let aulaNuevaRef = null;
                        let aulaNuevaDoc = null;
                        let aulaViejaRef = null;
                        let aulaViejaDoc = null;

                        if (actionToRevert.type !== 'Renovaci√≥n') { // Si es Traslado
                            const data = actionToRevert.data;
                            const detalles = data.detalles || data;
                            const aulaOrigenCode = detalles.aulaOrigen;
                            
                            // Preparar lectura de Aula Nueva (donde est√° ahora)
                            const aulaActualCode = currentData.aulaActual;
                            if (aulaActualCode && !aulaActualCode.includes('Sin aula')) {
                                const aulaNueva = dataCache.aulas.find(a => a.codigoAula === aulaActualCode);
                                if (aulaNueva) {
                                    aulaNuevaRef = doc(db, 'aulas', aulaNueva.id);
                                    aulaNuevaDoc = await t.get(aulaNuevaRef);
                                }
                            }

                            // Preparar lectura de Aula Vieja (a donde vuelve)
                            if (aulaOrigenCode) {
                                const aulaVieja = dataCache.aulas.find(a => a.codigoAula === aulaOrigenCode);
                                if (aulaVieja) {
                                    aulaViejaRef = doc(db, 'aulas', aulaVieja.id);
                                    aulaViejaDoc = await t.get(aulaViejaRef);
                                }
                            }
                        }

                        // --- FASE 2: ESCRITURAS (WRITES) ---
                        
                        if (actionToRevert.type === 'Renovaci√≥n') {
                            // 1. Borrar historial de renovaci√≥n
                            t.delete(doc(db, 'historialAlumnos', actionToRevert.id));
                            
                            // 2. Restaurar ciclo anterior
                            const cicloActual = parseInt(currentData.cicloInscrito);
                            if (cicloActual > 1) {
                                t.update(sRef, { cicloInscrito: cicloActual - 1 });
                            }
                            
                        } else { // Traslado
                            const data = actionToRevert.data;
                            const detalles = data.detalles || data;
                            const aulaOrigenCode = detalles.aulaOrigen;
                            const cicloOrigen = detalles.cicloOrigen;

                            // 1. Restaurar cupo en aula nueva (restar)
                            if (aulaNuevaDoc && aulaNuevaDoc.exists()) {
                                t.update(aulaNuevaRef, { cantidadAlumnos: Math.max(0, (aulaNuevaDoc.data().cantidadAlumnos || 1) - 1) });
                            }

                            // 2. Restaurar cupo en aula anterior (sumar)
                            if (aulaViejaDoc && aulaViejaDoc.exists()) {
                                t.update(aulaViejaRef, { cantidadAlumnos: (aulaViejaDoc.data().cantidadAlumnos || 0) + 1 });
                            }

                            // 3. Restaurar datos del alumno
                            t.update(sRef, { 
                                aulaActual: aulaOrigenCode || 'Sin Aula (Revertido)',
                                cicloInscrito: cicloOrigen || currentData.cicloInscrito 
                            });

                            // 4. Limpiar registros
                            if (actionToRevert.source === 'trasladosPendientes') {
                                t.delete(doc(db, 'trasladosPendientes', actionToRevert.id));
                            } else {
                                t.delete(doc(db, 'historialAlumnos', actionToRevert.id));
                                // Buscar y borrar traslado pendiente hu√©rfano (esto requiere una query, pero no podemos hacer queries dentro de transaction si no son lecturas directas por ID. 
                                // Como es limpieza, lo haremos fuera de la transacci√≥n si es necesario o asumimos que el ID es conocido).
                                // Nota: Para cumplir con la regla estricta, si necesitamos borrar un documento por query, mejor hacerlo fuera o cambiar la l√≥gica.
                                // Aqu√≠ simplificamos asumiendo que el ID principal basta.
                            }
                        }
                    });

                    // Limpieza adicional post-transacci√≥n (opcional pero recomendada para limpieza de hu√©rfanos)
                    if (actionToRevert.type !== 'Renovaci√≥n' && actionToRevert.source !== 'trasladosPendientes') {
                         const detalles = actionToRevert.data.detalles || actionToRevert.data;
                         const tpQuery = query(collection(db, 'trasladosPendientes'), where("alumnoId", "==", selectedStudentRevertLast.id), where("aulaDestino", "==", detalles.aulaDestino));
                         const tpSnap = await getDocs(tpQuery);
                         const batch = writeBatch(db);
                         tpSnap.forEach(d => batch.delete(d.ref));
                         await batch.commit();
                    }

                    await logAction("Anulaci√≥n Gesti√≥n", `Se revirti√≥ ${actionToRevert.type} para ${selectedStudentRevertLast.nombreCompleto}`);
                    showNotification("Gesti√≥n revertida y datos restaurados.", "success");
                    detailsRevertLast.classList.add('hidden');
                    document.getElementById('search-revert-last').value = '';
                    document.getElementById('results-revert-last').classList.add('hidden');

                } catch(e) { 
                    console.error(e); 
                    showNotification("Error cr√≠tico al revertir: " + e.message, "error"); 
                }
            });

            // --- 4. Revertir Pausa/Retiro ---
            const searchRevertPause = document.getElementById('search-revert-pause');
            let selectedStudentRevertPause = null;
            let lastPauseRecord = null;

            setupToolSearch('search-revert-pause', 'results-revert-pause', 'alumnos', async (s) => {
                selectedStudentRevertPause = s;
                const detailsDiv = document.getElementById('revert-pause-details');
                document.getElementById('student-revert-pause-name').textContent = s.nombreCompleto;
                document.getElementById('revert-pause-form').classList.remove('hidden');
                detailsDiv.innerHTML = '<div class="loader"></div> Buscando historial...';
                document.getElementById('confirm-revert-pause-btn').disabled = true;

                const q = query(collection(db, "historialAlumnos"), 
                    where("alumnoId", "==", s.id), 
                    where("tipoAccion", "in", ["Pausado", "Retirado", "Retiro"]),
                    orderBy("fecha", "desc"), 
                    limit(1)
                );
                
                const snap = await getDocs(q);
                if (snap.empty) {
                    detailsDiv.innerHTML = '<p class="text-red-500">No se encontr√≥ registro de la pausa/retiro en el historial reciente.</p>';
                } else {
                    lastPauseRecord = { id: snap.docs[0].id, ...snap.docs[0].data() };
                    const aulaOrigen = lastPauseRecord.detalles?.aulaOrigen || lastPauseRecord.detalles?.aula || 'Desconocida';
                    const cicloOrigen = lastPauseRecord.detalles?.cicloOrigen || 'N/A';
                    
                    detailsDiv.innerHTML = `
                        <p><strong>√öltima Acci√≥n:</strong> ${lastPauseRecord.tipoAccion}</p>
                        <p><strong>Fecha:</strong> ${safeToDate(lastPauseRecord.fecha).toLocaleDateString()}</p>
                        <p><strong>Aula Anterior:</strong> ${aulaOrigen} (Ciclo ${cicloOrigen})</p>
                        <p class="mt-2 text-xs text-gray-500">Al confirmar, el alumno volver√° a estar 'Activo' en esta aula para que puedas gestionarlo.</p>
                    `;
                    document.getElementById('confirm-revert-pause-btn').disabled = false;
                }
            }, s => ['Pausado', 'Retirado'].includes(s.estado));

            document.getElementById('confirm-revert-pause-btn').addEventListener('click', async () => {
                if(!selectedStudentRevertPause || !lastPauseRecord) return;
                if(!await customConfirm("¬øRestaurar alumno al aula anterior?")) return;

                try {
                    await runTransaction(db, async (t) => {
                        const sRef = doc(db, 'alumnos', selectedStudentRevertPause.id);
                        const hRef = doc(db, 'historialAlumnos', lastPauseRecord.id);
                        
                        const aulaCode = lastPauseRecord.detalles?.aulaOrigen || lastPauseRecord.detalles?.aula;
                        if (aulaCode) {
                            const aula = dataCache.aulas.find(a => a.codigoAula === aulaCode);
                            if (aula && aula.estado !== 'Cerrada') {
                                const aRef = doc(db, 'aulas', aula.id);
                                const aDoc = await t.get(aRef);
                                t.update(aRef, { cantidadAlumnos: (aDoc.data().cantidadAlumnos || 0) + 1 });
                            }
                        }

                        t.update(sRef, { 
                            estado: 'Activo', 
                            aulaActual: aulaCode || 'Sin Aula (Restaurado)', 
                        });
                        t.delete(hRef);
                    });
                    
                    await logAction("Reversi√≥n Pausa/Retiro", `Se restaur√≥ a ${selectedStudentRevertPause.nombreCompleto} al estado Activo.`);
                    showNotification("Alumno restaurado exitosamente.", "success");
                    document.getElementById('revert-pause-form').classList.add('hidden');
                } catch(e) { console.error(e); showNotification("Error al restaurar", "error"); }
            });

            // --- Funciones Auxiliares ---
            function setupToolSearch(inputId, resultsId, dataCollection, onSelectCallback, filterFn = null) {
                const input = document.getElementById(inputId);
                const results = document.getElementById(resultsId);
                let timeout;
                input.addEventListener('input', () => {
                    clearTimeout(timeout);
                    const term = input.value.trim().toLowerCase();
                    if (term.length < 3) { results.classList.add('hidden'); results.innerHTML = ''; return; }
                    timeout = setTimeout(() => {
                        let sourceData = dataCache[dataCollection];
                        if (filterFn) sourceData = sourceData.filter(filterFn);
                        const matches = sourceData.filter(item => {
                            const main = item.nombreCompleto || item.codigoAula || '';
                            return main.toLowerCase().includes(term) || (item.documentoIdentidad || '').includes(term);
                        });
                        results.innerHTML = '';
                        results.classList.remove('hidden');
                        if (matches.length === 0) results.innerHTML = '<p class="p-2 text-sm text-gray-500">Sin resultados.</p>';
                        else matches.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'p-2 border-b cursor-pointer hover:bg-gray-100 text-sm';
                            div.textContent = `${item.nombreCompleto || item.codigoAula}`;
                            div.addEventListener('click', () => {
                                results.classList.add('hidden');
                                input.value = '';
                                onSelectCallback(item);
                            });
                            results.appendChild(div);
                        });
                    }, 400);
                });
            }

            // ... (Resto de implementaciones de otras herramientas se mantienen igual) ...
            
            // Revertir Reincorporaci√≥n
            setupToolSearch('search-student-revert-reinc', 'student-revert-reinc-results', 'alumnos', async (s) => {
                const detailsDiv = document.getElementById('revert-reinc-details');
                document.getElementById('student-revert-reinc-name').textContent = s.nombreCompleto;
                document.getElementById('revert-reinc-form').classList.remove('hidden');
                detailsDiv.innerHTML = '<div class="loader"></div> Buscando registro...';
                document.getElementById('revert-reinc-btn').disabled = true;
                const q = query(collection(db, "historialAlumnos"), where("alumnoId", "==", s.id), where("tipoAccion", "==", "Reincorporaci√≥n"), orderBy("fecha", "desc"), limit(1));
                const snap = await getDocs(q);
                if (snap.empty) { detailsDiv.innerHTML = '<p class="text-red-500">No tiene reincorporaciones recientes.</p>'; } 
                else {
                    const rec = snap.docs[0].data();
                    rec.id = snap.docs[0].id;
                    const btn = document.getElementById('revert-reinc-btn');
                    btn.dataset.historyId = rec.id; btn.dataset.studentId = s.id; btn.disabled = false;
                    detailsDiv.innerHTML = `<p><strong>Fecha:</strong> ${safeToDate(rec.fecha).toLocaleDateString()}</p><p><strong>Aula Destino:</strong> ${rec.detalles.aula || 'N/A'}</p>`;
                }
            }, s => s.estado === 'Activo');
            document.getElementById('revert-reinc-btn').addEventListener('click', async (e) => {
                if(!await customConfirm("¬øRevertir reincorporaci√≥n?")) return;
                try {
                    await runTransaction(db, async (t) => {
                        const sRef = doc(db, 'alumnos', e.target.dataset.studentId);
                        const hRef = doc(db, 'historialAlumnos', e.target.dataset.historyId);
                        const sDoc = await t.get(sRef);
                        const sData = sDoc.data();
                        if(sData.aulaActual) {
                            const aula = dataCache.aulas.find(a => a.codigoAula === sData.aulaActual);
                            if(aula) { const aRef = doc(db, 'aulas', aula.id); const aDoc = await t.get(aRef); t.update(aRef, { cantidadAlumnos: Math.max(0, (aDoc.data().cantidadAlumnos || 1) - 1) }); }
                        }
                        t.update(sRef, { estado: 'Pausado', aulaActual: null });
                        t.delete(hRef);
                    });
                    showNotification("Reincorporaci√≥n revertida", "success");
                    document.getElementById('revert-reinc-form').classList.add('hidden');
                } catch(e) { console.error(e); showNotification("Error", "error"); }
            });

            // Revertir Inscripci√≥n
            setupToolSearch('search-student-revert-insc', 'student-revert-insc-results', 'alumnos', async (s) => {
                const detailsDiv = document.getElementById('revert-insc-details');
                document.getElementById('student-revert-insc-name').textContent = s.nombreCompleto;
                document.getElementById('revert-insc-form').classList.remove('hidden');
                detailsDiv.innerHTML = '<div class="loader"></div> Buscando registro...';
                document.getElementById('revert-insc-btn').disabled = true;
                const q = query(collection(db, "historialAlumnos"), where("alumnoId", "==", s.id), where("tipoAccion", "==", "Inscripci√≥n"), orderBy("fecha", "desc"), limit(1));
                const snap = await getDocs(q);
                if (snap.empty) { detailsDiv.innerHTML = '<p class="text-red-500">No se encontr√≥ inscripci√≥n inicial.</p>'; } 
                else {
                    const rec = snap.docs[0].data();
                    rec.id = snap.docs[0].id;
                    const btn = document.getElementById('revert-insc-btn');
                    btn.dataset.historyId = rec.id; btn.dataset.studentId = s.id; btn.disabled = false;
                    detailsDiv.innerHTML = `<p><strong>Fecha:</strong> ${safeToDate(rec.fecha).toLocaleDateString()}</p><p><strong>Aula Inscripci√≥n:</strong> ${rec.detalles.aula || 'N/A'}</p>`;
                }
            }, s => s.estado === 'Activo');
            document.getElementById('revert-insc-btn').addEventListener('click', async (e) => {
                if(!await customConfirm("¬øRevertir inscripci√≥n?")) return;
                try {
                    await runTransaction(db, async (t) => {
                        const sRef = doc(db, 'alumnos', e.target.dataset.studentId);
                        const hRef = doc(db, 'historialAlumnos', e.target.dataset.historyId);
                        const sDoc = await t.get(sRef);
                        const sData = sDoc.data();
                        if(sData.aulaActual) {
                            const aula = dataCache.aulas.find(a => a.codigoAula === sData.aulaActual);
                            if(aula) { const aRef = doc(db, 'aulas', aula.id); const aDoc = await t.get(aRef); t.update(aRef, { cantidadAlumnos: Math.max(0, (aDoc.data().cantidadAlumnos || 1) - 1) }); }
                        }
                        t.update(sRef, { estado: 'Registrado', aulaActual: null, cicloInscrito: null });
                        t.delete(hRef);
                    });
                    showNotification("Inscripci√≥n revertida", "success");
                    document.getElementById('revert-insc-form').classList.add('hidden');
                } catch(e) { console.error(e); showNotification("Error", "error"); }
            });

            // Limpiar Nota
            setupToolSearch('search-student-history', 'student-history-results', 'alumnos', async (s) => {
                const container = document.getElementById('history-records-container');
                container.innerHTML = '<div class="loader"></div>'; container.classList.remove('hidden');
                const q = query(collection(db, "historialAlumnos"), where("alumnoId", "==", s.id), orderBy("fecha", "desc"));
                const snap = await getDocs(q);
                container.innerHTML = `<h5 class="font-bold border-b pb-2 mb-2">Historial de ${s.nombreCompleto}</h5>`;
                if(snap.empty) { container.innerHTML += '<p class="text-gray-500">Sin historial.</p>'; return; }
                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    if(d.detalles && d.detalles.notaFinal !== undefined) {
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center p-3 bg-white border rounded shadow-sm mb-2';
                        div.innerHTML = `<div><p class="font-bold text-sm">${d.tipoAccion} (${safeToDate(d.fecha).toLocaleDateString()})</p><p class="text-xs text-gray-500">Nota: ${d.detalles.notaFinal}</p></div>`;
                        const btn = document.createElement('button');
                        btn.className = 'text-red-500 text-xs font-bold border border-red-200 px-2 py-1 rounded hover:bg-red-50';
                        btn.textContent = 'Borrar Nota';
                        btn.onclick = async () => {
                            if(await customConfirm("¬øBorrar nota?")) {
                                await updateDoc(doc(db, "historialAlumnos", docSnap.id), { "detalles.notaFinal": deleteField() });
                                showNotification("Nota eliminada", "success");
                                div.remove();
                            }
                        };
                        div.appendChild(btn); container.appendChild(div);
                    }
                });
            });

            // Recuperar Aula
            setupToolSearch('search-aula-recover', 'aula-recover-results', 'historialCarteras', (h) => {
                document.getElementById('aula-recover-name').textContent = h.datosAula.codigoAula;
                document.getElementById('recover-aula-btn').onclick = async () => {
                    if(!await customConfirm("¬øRestaurar esta aula?")) return;
                    try {
                        const aulaData = h.datosAula;
                        if (aulaData.fechaInicio && !aulaData.fechaInicio.toDate) aulaData.fechaInicio = Timestamp.fromDate(new Date(aulaData.fechaInicio));
                        if (aulaData.fechaFin && !aulaData.fechaFin.toDate) aulaData.fechaFin = Timestamp.fromDate(new Date(aulaData.fechaFin));
                        await setDoc(doc(db, "aulas", h.aulaId), aulaData);
                        await logAction('Recuperaci√≥n Aula', `Se restaur√≥ el aula ${aulaData.codigoAula}`);
                        showNotification("Aula restaurada", "success");
                        document.getElementById('aula-recover-form').classList.add('hidden');
                    } catch(e) { console.error(e); showNotification("Error", "error"); }
                };
                document.getElementById('aula-recover-form').classList.remove('hidden');
            }, null);
            // Override search for aula recover
            document.getElementById('search-aula-recover').addEventListener('input', (e) => {
                const term = e.target.value.trim().toLowerCase();
                const results = document.getElementById('aula-recover-results');
                if(term.length < 3) { results.classList.add('hidden'); return; }
                const matches = dataCache.historialCarteras.filter(h => h.datosAula.codigoAula.toLowerCase().includes(term));
                results.innerHTML = ''; results.classList.remove('hidden');
                if(matches.length === 0) results.innerHTML = '<p class="p-2 text-gray-500">No encontrada.</p>';
                else matches.forEach(h => {
                    const div = document.createElement('div'); div.className = 'p-2 hover:bg-gray-100 cursor-pointer text-sm'; div.textContent = `${h.datosAula.codigoAula} (Cerrada)`;
                    div.onclick = () => {
                        document.getElementById('aula-recover-name').textContent = h.datosAula.codigoAula;
                        document.getElementById('aula-recover-form').classList.remove('hidden');
                        results.classList.add('hidden');
                        e.target.value = '';
                        document.getElementById('recover-aula-btn').onclick = async () => {
                             if(!await customConfirm("¬øRestaurar esta aula?")) return;
                             try {
                                const aulaData = h.datosAula;
                                if (aulaData.fechaInicio && !aulaData.fechaInicio.toDate) aulaData.fechaInicio = Timestamp.fromDate(new Date(aulaData.fechaInicio));
                                if (aulaData.fechaFin && !aulaData.fechaFin.toDate) aulaData.fechaFin = Timestamp.fromDate(new Date(aulaData.fechaFin));
                                await setDoc(doc(db, "aulas", h.aulaId), aulaData);
                                showNotification("Aula restaurada", "success");
                                document.getElementById('aula-recover-form').classList.add('hidden');
                             } catch(err) { showNotification("Error", "error"); }
                        };
                    };
                    results.appendChild(div);
                });
            });

            // Correcci√≥n Asignaci√≥n
            let selectedStudentCorrection = null;
            setupToolSearch('search-student-correction', 'student-correction-results', 'alumnos', (s) => {
                selectedStudentCorrection = s;
                document.getElementById('student-correction-name').textContent = s.nombreCompleto;
                document.getElementById('current-aula-display').textContent = s.aulaActual || 'Ninguna';
                document.getElementById('student-correction-form').classList.remove('hidden');
                const select = document.getElementById('new-aula-select');
                select.innerHTML = '<option value="">Selecciona nueva aula...</option>';
                dataCache.aulas.filter(a => a.estado !== 'Cerrada').sort((a,b) => a.codigoAula.localeCompare(b.codigoAula)).forEach(a => {
                    select.innerHTML += `<option value="${a.codigoAula}">${a.codigoAula}</option>`;
                });
            });
            document.getElementById('correct-assignment-btn').addEventListener('click', async () => {
                const newAulaCode = document.getElementById('new-aula-select').value;
                if(!selectedStudentCorrection || !newAulaCode) return;
                if(!await customConfirm("¬øCorregir asignaci√≥n?")) return;
                try {
                    await runTransaction(db, async (t) => {
                        const sRef = doc(db, 'alumnos', selectedStudentCorrection.id);
                        let oldAulaRef = null; let newAulaRef = null;
                        if(selectedStudentCorrection.aulaActual) { const oldAula = dataCache.aulas.find(a => a.codigoAula === selectedStudentCorrection.aulaActual); if(oldAula) oldAulaRef = doc(db, 'aulas', oldAula.id); }
                        const newAula = dataCache.aulas.find(a => a.codigoAula === newAulaCode); if(newAula) newAulaRef = doc(db, 'aulas', newAula.id);
                        let oldDoc = null; let newDoc = null;
                        if(oldAulaRef) oldDoc = await t.get(oldAulaRef);
                        if(newAulaRef) newDoc = await t.get(newAulaRef);
                        if(oldDoc && oldDoc.exists()) { t.update(oldAulaRef, { cantidadAlumnos: Math.max(0, (oldDoc.data().cantidadAlumnos || 1) - 1) }); }
                        if(newDoc && newDoc.exists()) { t.update(newAulaRef, { cantidadAlumnos: (newDoc.data().cantidadAlumnos || 0) + 1 }); }
                        t.update(sRef, { aulaActual: newAulaCode, estado: 'Activo' });
                    });
                    await logAction('Correcci√≥n Asignaci√≥n', `Se movi√≥ a ${selectedStudentCorrection.nombreCompleto} a ${newAulaCode}`);
                    showNotification("Asignaci√≥n corregida", "success");
                    document.getElementById('student-correction-form').classList.add('hidden');
                } catch(e) { console.error(e); showNotification("Error: " + e.message, "error"); }
            });

            // Procesar Traslado
            let selectedTransferProcess = null;
            const pendingTransferInput = document.getElementById('search-pending-transfer');
            const pendingTransferResults = document.getElementById('pending-transfer-results');
            pendingTransferInput.addEventListener('input', () => {
                const term = pendingTransferInput.value.trim().toLowerCase();
                if(term.length < 3) { pendingTransferResults.classList.add('hidden'); return; }
                const matches = dataCache.trasladosPendientes.filter(t => t.estado === 'Pendiente' && t.nombreAlumno.toLowerCase().includes(term));
                pendingTransferResults.innerHTML = ''; pendingTransferResults.classList.remove('hidden');
                if(matches.length === 0) pendingTransferResults.innerHTML = '<p class="p-2 text-gray-500">Sin resultados.</p>';
                else matches.forEach(t => {
                    const div = document.createElement('div'); div.className = 'p-2 hover:bg-gray-100 cursor-pointer text-sm'; div.textContent = t.nombreAlumno;
                    div.onclick = () => {
                        selectedTransferProcess = t;
                        document.getElementById('pending-transfer-name').textContent = t.nombreAlumno;
                        document.getElementById('pending-transfer-origin').textContent = t.aulaOrigen;
                        document.getElementById('pending-transfer-destination').textContent = t.aulaDestino;
                        document.getElementById('pending-transfer-form').classList.remove('hidden');
                        pendingTransferResults.classList.add('hidden');
                        pendingTransferInput.value = '';
                    };
                    pendingTransferResults.appendChild(div);
                });
            });
            document.getElementById('process-transfer-btn').addEventListener('click', async () => {
                if(!selectedTransferProcess) return;
                if(!await customConfirm("¬øProcesar traslado?")) return;
                try {
                    await runTransaction(db, async (t) => {
                        const sRef = doc(db, "alumnos", selectedTransferProcess.alumnoId);
                        const tRef = doc(db, "trasladosPendientes", selectedTransferProcess.id);
                        const destAula = dataCache.aulas.find(a => a.codigoAula === selectedTransferProcess.aulaDestino);
                        if(destAula) { const dRef = doc(db, "aulas", destAula.id); const dDoc = await t.get(dRef); t.update(dRef, { cantidadAlumnos: (dDoc.data().cantidadAlumnos || 0) + 1 }); }
                        t.update(sRef, { estado: 'Activo', aulaActual: selectedTransferProcess.aulaDestino, cicloInscrito: selectedTransferProcess.cicloDestino });
                        t.update(tRef, { estado: 'Completado' });
                    });
                    showNotification("Traslado procesado", "success");
                    document.getElementById('pending-transfer-form').classList.add('hidden');
                } catch(e) { showNotification("Error", "error"); }
            });

            // Borrado Espec√≠fico
            setupToolSearch('search-specific-input', 'search-specific-results', 'alumnos', (item) => {
                selectedRecordForDelete = item;
                document.getElementById('record-name-display').textContent = item.nombreCompleto || item.codigoAula || item.email;
                document.getElementById('record-to-delete-container').classList.remove('hidden');
            }, null);
            // Override dynamic collection for delete
            const deleteTypeSelect = document.getElementById('delete-type-select');
            deleteTypeSelect.addEventListener('change', () => {
                document.getElementById('search-specific-input').value = '';
                document.getElementById('search-specific-results').innerHTML = '';
                document.getElementById('record-to-delete-container').classList.add('hidden');
            });
            document.getElementById('search-specific-input').addEventListener('input', (e) => {
                // Re-bind with correct collection
                const term = e.target.value.trim().toLowerCase();
                const collName = deleteTypeSelect.value;
                const resultsEl = document.getElementById('search-specific-results');
                if(term.length < 3) { resultsEl.classList.add('hidden'); return; }
                const matches = dataCache[collName].filter(item => {
                    const main = item.nombreCompleto || item.codigoAula || item.email || '';
                    return main.toLowerCase().includes(term);
                });
                resultsEl.innerHTML = ''; resultsEl.classList.remove('hidden');
                if(matches.length === 0) resultsEl.innerHTML = '<p class="p-2 text-sm text-gray-500">Sin resultados.</p>';
                matches.forEach(item => {
                    const div = document.createElement('div'); div.className = 'p-2 border-b cursor-pointer hover:bg-gray-100 text-sm';
                    div.textContent = item.nombreCompleto || item.codigoAula || item.email;
                    div.addEventListener('click', () => {
                        selectedRecordForDelete = item;
                        document.getElementById('record-name-display').textContent = div.textContent;
                        document.getElementById('record-to-delete-container').classList.remove('hidden');
                        resultsEl.classList.add('hidden');
                        e.target.value = '';
                    });
                    resultsEl.appendChild(div);
                });
            });

            // Revertir Egreso
            setupToolSearch('search-student-revert', 'student-revert-results', 'alumnos', (s) => {
                document.getElementById('student-revert-name').textContent = s.nombreCompleto;
                document.getElementById('revert-egreso-btn').onclick = async () => {
                    if(await customConfirm("¬øRevertir egreso?")) {
                        const q = query(collection(db, "historialAlumnos"), where("alumnoId", "==", s.id), where("tipoAccion", "==", "Egreso"), limit(1));
                        const snap = await getDocs(q);
                        if(!snap.empty) await deleteDoc(snap.docs[0].ref);
                        await updateDoc(doc(db, "alumnos", s.id), { estado: 'Activo' });
                        showNotification("Hecho", "success");
                        document.getElementById('student-revert-form').classList.add('hidden');
                    }
                };
                document.getElementById('student-revert-form').classList.remove('hidden');
            }, s => s.estado === 'Egresado');

        });
    </script>
</body>
</html>